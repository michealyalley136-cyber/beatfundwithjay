{% extends "base.html" %}
{% block title %}Wallet · BeatFund{% endblock %}

{% block extra_head %}
<style>
  .wallet-shell{
    max-width: 1120px;
    margin: 24px auto 40px;
    padding-inline: 16px;
  }

  .wallet-tabs {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin: 10px 0 18px;
  }

  .wallet-tab {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border-radius: 999px;
    padding: 7px 12px;
    font-size: 12px;
    border: 1px solid rgba(51, 65, 85, 0.9);
    background: rgba(15, 23, 42, 0.92);
    color: #c7d2fe;
    text-decoration: none;
    transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
  }

  .wallet-tab:hover {
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(15, 23, 42, 0.65);
  }

  .wallet-tab.active {
    background: linear-gradient(135deg, #4de3ff, #6366f1);
    color: #ffffff;
    border-color: rgba(99, 102, 241, 0.8);
    box-shadow: 0 10px 24px rgba(79, 70, 229, 0.55);
  }

  .wallet-page {
    display: grid;
    grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
    gap: 24px;
  }

  @media (max-width: 960px) {
    .wallet-page { grid-template-columns: minmax(0, 1fr); }
  }

  .wallet-card {
    border-radius: 22px;
    border: 1px solid rgba(37, 99, 235, 0.9);
    background:
      radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.22), transparent 60%),
      radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.28), transparent 60%),
      rgba(15, 23, 42, 0.98);
    box-shadow:
      0 28px 48px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(15, 23, 42, 1) inset;
    padding: 18px 20px 18px;
    position: relative;
    overflow: hidden;
  }

  .wallet-card::before {
    content: "";
    position: absolute;
    inset: -40%;
    background:
      radial-gradient(circle at 15% 0%, rgba(59, 130, 246, 0.25), transparent 60%),
      radial-gradient(circle at 85% 100%, rgba(45, 212, 191, 0.25), transparent 60%);
    opacity: 0.3;
    pointer-events: none;
  }

  .wallet-card-inner {
    position: relative;
    z-index: 1;
  }

  .wallet-title-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 14px;
  }

  .wallet-title { font-size: 18px; font-weight: 600; }
  .wallet-sub { font-size: 12px; color: #9ca3c8; }

  .wallet-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.45);
    background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
    color: #e5e7eb;
  }

  .wallet-pill-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: #4ade80;
  }

  .wallet-balance-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: #8f9bc6;
    margin-bottom: 4px;
  }

  .wallet-balance-value {
    font-size: 30px;
    font-weight: 650;
    letter-spacing: 0.02em;
  }

  .wallet-balance-row {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 18px;
  }

  .wallet-action-toggle {
    display: inline-flex;
    flex-wrap: wrap;
    border-radius: 999px;
    padding: 2px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid rgba(51, 65, 85, 0.9);
    margin-bottom: 10px;
  }

  .wallet-action-pill {
    border-radius: 999px;
    padding: 5px 12px;
    font-size: 11px;
    border: none;
    cursor: pointer;
    background: transparent;
    color: #a5b4fc;
    white-space: nowrap;
    transition: background 0.12s ease, color 0.12s ease, transform 0.07s ease;
  }

  .wallet-action-pill.active {
    background: linear-gradient(135deg, #4de3ff, #6366f1);
    color: white;
    transform: translateY(-0.5px);
    box-shadow: 0 4px 14px rgba(79, 70, 229, 0.6);
  }

  .wallet-form-shell {
    border-radius: 16px;
    border: 1px solid rgba(30, 64, 175, 0.9);
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
    box-shadow:
      0 18px 40px rgba(15, 23, 42, 0.9),
      0 0 0 1px rgba(15, 23, 42, 1) inset;
    padding: 12px 12px 13px;
  }

  .wallet-form-title { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
  .wallet-form-helper { font-size: 11px; color: #9ca3c8; margin-bottom: 10px; }

  .wallet-field-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: #8f9bc6;
    margin-bottom: 2px;
  }

  .wallet-input {
    width: 100%;
    border-radius: 10px;
    border: 1px solid #303a5c;
    background: radial-gradient(circle at top, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 1));
    color: #e3e9ff;
    padding: 7px 9px;
    font-size: 12px;
    outline: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, transform 0.06s ease;
  }

  .wallet-input::placeholder { color: #6f7aa4; }

  .wallet-input:focus {
    border-color: #4f8bff;
    box-shadow: 0 0 0 1px rgba(79, 139, 255, 0.4);
    transform: translateY(-0.5px);
  }

  .wallet-row-inline {
    display: grid;
    grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
    gap: 8px;
  }

  @media (max-width: 640px) {
    .wallet-row-inline { grid-template-columns: minmax(0, 1fr); }
  }

  .wallet-btn {
    border-radius: 999px;
    padding: 8px 14px;
    font-size: 13px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #4de3ff, #6366f1);
    color: #ffffff;
    box-shadow: 0 6px 18px rgba(56, 189, 248, 0.45);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    margin-top: 10px;
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.12s ease;
  }

  .wallet-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(79, 70, 229, 0.55); }
  .wallet-btn:active { transform: translateY(0); box-shadow: 0 4px 12px rgba(30, 64, 175, 0.7); }

  .wallet-secondary-note { font-size: 10px; color: #9ca3c8; margin-top: 6px; }

  .wallet-activity-card {
    border-radius: 22px;
    border: 1px solid rgba(51, 65, 85, 0.9);
    background:
      radial-gradient(circle at 0% 0%, rgba(30, 64, 175, 0.25), transparent 60%),
      radial-gradient(circle at 100% 100%, rgba(15, 23, 42, 1), rgba(15, 23, 42, 1));
    box-shadow:
      0 24px 40px rgba(15, 23, 42, 0.95),
      0 0 0 1px rgba(15, 23, 42, 1) inset;
    padding: 18px 16px 14px;
  }

  .wallet-activity-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .wallet-activity-sub { font-size: 11px; color: #9ca3c8; margin-bottom: 10px; }

  .wallet-activity-list { list-style: none; padding: 0; margin: 0; }

  .wallet-activity-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 8px;
    border-radius: 12px;
    border: 1px solid rgba(51, 65, 85, 0.7);
    background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 1));
    margin-bottom: 6px;
  }

  .wallet-activity-left { min-width: 0; }
  .wallet-activity-main { font-size: 12px; }
  .wallet-activity-meta { font-size: 11px; color: #9ca3c8; margin-top: 1px; }
  .wallet-activity-date { font-size: 10px; color: #6b7280; margin-top: 1px; }

  .wallet-activity-amount { font-size: 13px; font-weight: 600; white-space: nowrap; }
  .wallet-activity-amount.credit { color: #4ade80; }
  .wallet-activity-amount.debit { color: #f97373; }

  .wallet-empty-state { font-size: 11px; color: #9ca3c8; padding: 8px 6px 4px; }

  /* Transactions table */
  .wallet-ledger-wrap {
    overflow: auto;
    border-radius: 16px;
    border: 1px solid rgba(51, 65, 85, 0.7);
    background: rgba(15, 23, 42, 0.75);
  }

  .wallet-ledger-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 760px;
  }

  .wallet-ledger-table th, .wallet-ledger-table td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(51, 65, 85, 0.55);
    vertical-align: top;
  }

  .wallet-ledger-table th {
    text-align: left;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.10em;
    color: #a5b4fc;
    background: rgba(15, 23, 42, 0.92);
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .wallet-ledger-type { font-size: 12px; }
  .wallet-ledger-meta { font-size: 11px; color: #9ca3c8; margin-top: 2px; }
  .wallet-ledger-date { font-size: 11px; color: #94a3b8; white-space: nowrap; }
  .wallet-ledger-amt { font-size: 13px; font-weight: 650; white-space: nowrap; }
  .wallet-ledger-amt.credit { color: #4ade80; }
  .wallet-ledger-amt.debit { color: #f97373; }
</style>

<script nonce="{{ csp_nonce }}">
  window.addEventListener("DOMContentLoaded", function () {
    const pills = document.querySelectorAll("[data-wallet-action-pill]");
    const actionInput = document.getElementById("wallet-action-input");
    const helperEl = document.getElementById("wallet-helper-text");
    const submitLabelEl = document.getElementById("wallet-submit-label");

    const rowRecipient = document.getElementById("wallet-row-recipient");
    const rowMethod = document.getElementById("wallet-row-method");
    const rowNote = document.getElementById("wallet-row-note");

    function setAction(action) {
      if (actionInput) actionInput.value = action;

      pills.forEach(p => {
        if (p.dataset.walletActionPill === action) p.classList.add("active");
        else p.classList.remove("active");
      });

      if (action === "add") {
        if (helperEl) helperEl.textContent =
          "Top up your BeatFund balance before buying beats or confirming bookings.";
        if (submitLabelEl) submitLabelEl.textContent = "Add funds (demo)";
        if (rowRecipient) rowRecipient.style.display = "none";
        if (rowNote) rowNote.style.display = "none";
        if (rowMethod) rowMethod.style.display = "block";
      } else if (action === "send") {
        if (helperEl) helperEl.textContent =
          "Pay collaborators by their BeatFund handle. Instant wallet-to-wallet transfer.";
        if (submitLabelEl) submitLabelEl.textContent = "Send payment";
        if (rowRecipient) rowRecipient.style.display = "block";
        if (rowNote) rowNote.style.display = "block";
        if (rowMethod) rowMethod.style.display = "none";
      } else if (action === "withdraw") {
        if (helperEl) helperEl.textContent =
          "Move funds out of BeatFund in production. In this dev build, this only creates a ledger entry.";
        if (submitLabelEl) submitLabelEl.textContent = "Withdraw (demo)";
        if (rowRecipient) rowRecipient.style.display = "none";
        if (rowNote) rowNote.style.display = "none";
        if (rowMethod) rowMethod.style.display = "none";
      }
    }

    pills.forEach(p => {
      p.addEventListener("click", function () {
        const action = this.dataset.walletActionPill;
        setAction(action);
      });
    });

    setAction("add");
  });
</script>
{% endblock %}

{% block content %}
{% set active_tab = (tab if tab is defined and tab else (request.args.get('tab', 'overview') if request is defined else 'overview')) %}

<div class="wallet-shell">
  <div class="wallet-tabs">
    <a class="wallet-tab {{ 'active' if active_tab != 'transactions' else '' }}"
       href="{{ (request.path if request is defined else '') }}">
      Overview
    </a>

    <a class="wallet-tab {{ 'active' if active_tab == 'transactions' else '' }}"
       href="{{ (request.path if request is defined else '') }}?tab=transactions">
      Transactions
    </a>
  </div>

  {% set credit_types = [
    EntryType.deposit,
    EntryType.transfer_in,
    EntryType.interest,
    EntryType.adjustment,
    EntryType.sale_income
  ] %}

  {% if active_tab == 'transactions' %}
    {# =========================
       TRANSACTIONS TAB
       ========================= #}
    <section class="wallet-activity-card" aria-label="Wallet transactions">
      <div class="wallet-activity-title">Transactions</div>
      <div class="wallet-activity-sub">
        Full wallet ledger view. (If you don’t pass a separate list yet, this falls back to your <code>recent</code> list.)
      </div>

      {% set txns = (transactions if transactions is defined and transactions else recent) %}

      {% if txns and txns|length > 0 %}
        <div class="wallet-ledger-wrap">
          <table class="wallet-ledger-table">
            <thead>
              <tr>
                <th style="width: 170px;">Date</th>
                <th>Type / Details</th>
                <th style="width: 140px; text-align:right;">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in txns %}
                {% set is_credit = entry.entry_type in credit_types %}
                <tr>
                  <td class="wallet-ledger-date">
                    {{ entry.created_at.strftime("%b %d, %Y · %I:%M %p") if entry.created_at else "" }}
                  </td>
                  <td>
                    <div class="wallet-ledger-type">
                      {% if entry.entry_type == EntryType.deposit %}
                        Deposit
                      {% elif entry.entry_type == EntryType.withdrawal %}
                        Withdrawal
                      {% elif entry.entry_type == EntryType.transfer_in %}
                        Transfer in
                      {% elif entry.entry_type == EntryType.transfer_out %}
                        Transfer out
                      {% elif entry.entry_type == EntryType.sale_income %}
                        Sale income
                      {% elif entry.entry_type == EntryType.purchase_spend %}
                        Purchase
                      {% else %}
                        {{ entry.entry_type.value|replace("_", " ")|title }}
                      {% endif %}
                    </div>

                    {% if entry.meta %}
                      <div class="wallet-ledger-meta">{{ entry.meta }}</div>
                    {% endif %}
                  </td>
                  <td style="text-align:right;">
                    <span class="wallet-ledger-amt {{ 'credit' if is_credit else 'debit' }}">
                      {% if is_credit %}+{% else %}-{% endif %}${{ "%.2f"|format(entry.amount_cents / 100.0) }}
                    </span>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="wallet-empty-state">
          No transactions yet.
        </div>
      {% endif %}
    </section>

  {% else %}
    {# =========================
       OVERVIEW TAB (your original layout)
       ========================= #}
    <div class="wallet-page">
      <!-- Left: balance + single consolidated action form -->
      <section class="wallet-card" aria-label="Wallet overview">
        <div class="wallet-card-inner">
          <div class="wallet-title-row">
            <div>
              <div class="wallet-title">BeatFund Wallet</div>
              <div class="wallet-sub">
                Hold funds for beats, bookings, and provider payouts — no hidden platform fees on deposits.
              </div>
            </div>
            <div class="wallet-pill">
              <span class="wallet-pill-dot"></span>
              <span>Dev environment · demo money only</span>
            </div>
          </div>

          <div class="wallet-balance-row">
            <div>
              <div class="wallet-balance-label">Available balance</div>
              <div class="wallet-balance-value">
                ${{ "%.2f"|format(balance or 0.0) }}
              </div>
            </div>
          </div>

          <!-- Action toggle -->
          <div class="wallet-action-toggle" role="tablist" aria-label="Wallet actions">
            <button type="button"
                    class="wallet-action-pill active"
                    data-wallet-action-pill="add"
                    role="tab">
              Add funds
            </button>
            <button type="button"
                    class="wallet-action-pill"
                    data-wallet-action-pill="send"
                    role="tab">
              Send to user
            </button>
            <button type="button"
                    class="wallet-action-pill"
                    data-wallet-action-pill="withdraw"
                    role="tab">
              Withdraw (demo)
            </button>
          </div>

          <!-- Single consolidated form -->
          <div class="wallet-form-shell">
            <div class="wallet-form-title">Quick wallet action</div>
            <div class="wallet-form-helper" id="wallet-helper-text">
              Top up your BeatFund balance before buying beats or confirming bookings.
            </div>

            <form method="POST" action="{{ url_for('wallet_action') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="action" id="wallet-action-input" value="add">

              <!-- Amount row (always visible) -->
              <div class="wallet-row-inline">
                <div>
                  <div class="wallet-field-label">Amount (USD)</div>
                  <input
                    type="text"
                    name="amount"
                    class="wallet-input"
                    placeholder="e.g. 50.00"
                    required
                  >
                </div>

                <!-- Recipient handle: send only -->
                <div id="wallet-row-recipient">
                  <div class="wallet-field-label">Recipient handle</div>
                  <input
                    type="text"
                    name="handle"
                    class="wallet-input"
                    placeholder="@producer1"
                  >
                </div>
              </div>

              <!-- Method (note): add only -->
              <div id="wallet-row-method" style="margin-top:8px;">
                <div class="wallet-field-label">Method (note only)</div>
                <input
                  type="text"
                  name="method"
                  class="wallet-input"
                  placeholder="Card / bank / mobile money (demo)"
                >
              </div>

              <!-- Note: send only -->
              <div id="wallet-row-note" style="margin-top:8px;">
                <div class="wallet-field-label">Note (optional)</div>
                <input
                  type="text"
                  name="note"
                  class="wallet-input"
                  placeholder="e.g. Beat split, session fee"
                >
              </div>

              <button type="submit" class="wallet-btn" id="wallet-submit-label">
                Add funds (demo)
              </button>

              <div class="wallet-secondary-note">
                In this dev build, all movements are simulated on the ledger only.
                When we go live, this screen will connect to real payment rails and payouts.
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- Right: recent activity -->
      <section class="wallet-activity-card" aria-label="Recent wallet activity">
        <div class="wallet-activity-title">Recent activity</div>
        <div class="wallet-activity-sub">
          Last 10 movements in and out of your BeatFund wallet.
        </div>

        {% if recent and recent|length > 0 %}
          <ul class="wallet-activity-list">
            {% for entry in recent %}
              {% set is_credit = entry.entry_type in credit_types %}
              <li class="wallet-activity-item">
                <div class="wallet-activity-left">
                  <div class="wallet-activity-main">
                    {% if entry.entry_type == EntryType.deposit %}
                      Deposit
                    {% elif entry.entry_type == EntryType.withdrawal %}
                      Withdrawal
                    {% elif entry.entry_type == EntryType.transfer_in %}
                      Transfer in
                    {% elif entry.entry_type == EntryType.transfer_out %}
                      Transfer out
                    {% elif entry.entry_type == EntryType.sale_income %}
                      Sale income
                    {% elif entry.entry_type == EntryType.purchase_spend %}
                      Purchase
                    {% else %}
                      {{ entry.entry_type.value|replace("_", " ")|title }}
                    {% endif %}
                  </div>

                  {% if entry.meta %}
                    <div class="wallet-activity-meta wrap-anywhere">{{ entry.meta }}</div>
                  {% endif %}

                  <div class="wallet-activity-date">
                    {{ entry.created_at.strftime("%b %d, %Y · %I:%M %p") if entry.created_at else "" }}
                  </div>
                </div>

                <div class="wallet-activity-amount {{ 'credit' if is_credit else 'debit' }}">
                  {% if is_credit %}+{% else %}-{% endif %}${{ "%.2f"|format(entry.amount_cents / 100.0) }}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="wallet-empty-state">
            No wallet activity yet. Add funds or buy a beat to see movements here.
          </div>
        {% endif %}
      </section>
    </div>
  {% endif %}
</div>
{% endblock %}
