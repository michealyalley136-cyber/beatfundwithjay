{% extends "base.html" %}
{% block title %}BookMe - Requests & Bookings - BeatFund{% endblock %}

{% block content %}
{% set incoming_requests = requests_incoming|default([]) %}
{% set sent_requests = requests_sent|default([]) %}
{% set provider_bookings = bookings_as_provider|default([]) %}
{% set client_bookings = bookings_as_client|default([]) %}

<div class="page bookme-requests-page">
  <header class="page-header">
    <h1>BookMe - Requests & Bookings</h1>
    <p class="text-muted">Track requests, confirm holds, and manage all bookings in one place.</p>
  </header>

  <section class="summary-strip">
    <div class="summary-pill">
      <span>Incoming requests</span>
      <strong>{{ incoming_requests|length }}</strong>
    </div>
    <div class="summary-pill">
      <span>Sent requests</span>
      <strong>{{ sent_requests|length }}</strong>
    </div>
    <div class="summary-pill">
      <span>Bookings as provider</span>
      <strong>{{ provider_bookings|length }}</strong>
    </div>
    <div class="summary-pill">
      <span>Bookings as client</span>
      <strong>{{ client_bookings|length }}</strong>
    </div>
  </section>

  <div class="bf-toolbar">
    <div class="bf-tabs">
      <button class="bf-tab is-active" type="button" data-tab="requests">Requests</button>
      <button class="bf-tab" type="button" data-tab="bookings">Bookings</button>
    </div>
    <div class="bf-filters">
      <input id="bf-search" type="search" placeholder="Search name or date" autocomplete="off" />
      <select id="bf-status-filter">
        <option value="all">All statuses</option>
        <option value="pending">Pending</option>
        <option value="accepted">Accepted</option>
        <option value="confirmed">Confirmed</option>
        <option value="quoted">Quoted</option>
        <option value="declined">Declined</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>
  </div>

  <div class="bf-segmented" data-tab="requests">
    <button class="bf-seg is-active" type="button" data-segment="incoming">Incoming</button>
    <button class="bf-seg" type="button" data-segment="sent">Sent</button>
  </div>

  <div class="bf-segmented is-hidden" data-tab="bookings">
    <button class="bf-seg is-active" type="button" data-segment="incoming">As provider</button>
    <button class="bf-seg" type="button" data-segment="sent">As client</button>
  </div>

  <div class="bf-list" data-tab="requests" data-segment="incoming">
    {% if incoming_requests %}
      {% for req in incoming_requests %}
        {% set status_value = (req.status.value if req.status else "pending")|lower %}
        {% set deposit_paid = request_deposit_paid.get(req.id, False) %}
        {% set needs_action = (req.status == BookingStatus.pending) %}
        <article class="bf-row-card {% if needs_action %}needs-action{% endif %}" data-status="{{ status_value }}" data-search="{{ req.client.username }} {{ req.preferred_time or '' }}">
          <div class="bf-row-main">
            <div class="bf-row-title">@{{ req.client.username }}</div>
            <div class="bf-row-meta">
              <span class="bf-badge status-{{ status_value }}">{{ status_value.title() }}</span>
              <span>{{ req.preferred_time or "Time not set" }}</span>
              {% if req.duration_minutes %}
                <span>{{ '%.2f'|format(req.duration_minutes / 60.0) }} hrs</span>
              {% endif %}
            </div>
            {% if req.message %}
              <div class="bf-row-note">{{ req.message }}</div>
            {% endif %}
          </div>
          <div class="bf-row-side">
            <div class="bf-row-badges">
              <span class="bf-pill">Deposit: {{ "Paid" if deposit_paid else ("Due" if req.status == BookingStatus.accepted else "Waiting") }}</span>
            </div>
            {% if req.status == BookingStatus.pending %}
              <a class="btn btn-primary" href="{{ url_for('bookme_request_accept_confirm', req_id=req.id) }}">Review request</a>
            {% else %}
              <a class="btn btn-secondary" href="{{ url_for('booking_detail', booking_id=req.booking_id) if req.booking_id else url_for('bookme_requests') }}">View</a>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty-state">No incoming requests yet.</p>
    {% endif %}
  </div>

  <div class="bf-list is-hidden" data-tab="requests" data-segment="sent">
    {% if sent_requests %}
      {% for req in sent_requests %}
        {% set status_value = (req.status.value if req.status else "pending")|lower %}
        {% set deposit_paid = request_deposit_paid.get(req.id, False) %}
        {% set needs_action = (req.status == BookingStatus.accepted and not deposit_paid) %}
        <article class="bf-row-card {% if needs_action %}needs-action{% endif %}" data-status="{{ status_value }}" data-search="{{ req.provider.username }} {{ req.preferred_time or '' }}">
          <div class="bf-row-main">
            <div class="bf-row-title">@{{ req.provider.username }}</div>
            <div class="bf-row-meta">
              <span class="bf-badge status-{{ status_value }}">{{ status_value.title() }}</span>
              <span>{{ req.preferred_time or "Time not set" }}</span>
              {% if req.duration_minutes %}
                <span>{{ '%.2f'|format(req.duration_minutes / 60.0) }} hrs</span>
              {% endif %}
            </div>
            {% if req.message %}
              <div class="bf-row-note">{{ req.message }}</div>
            {% endif %}
          </div>
          <div class="bf-row-side">
            <div class="bf-row-badges">
              <span class="bf-pill">Deposit: {{ "Paid" if deposit_paid else ("Due" if req.status == BookingStatus.accepted else "Waiting") }}</span>
            </div>
            {% if req.status == BookingStatus.accepted and not deposit_paid %}
              {% if req.booking_id %}
              <button class="btn btn-primary pay-hold-fee-btn" type="button" data-action="pay-hold" data-booking-id="{{ req.booking_id }}">
                Pay hold fee (${{ '%.2f'|format(HOLD_FEE_CENTS / 100.0) }})
              </button>
              {% else %}
                <span class="btn btn-disabled">Awaiting setup</span>
              {% endif %}
            {% elif req.status == BookingStatus.pending %}
              <form method="post" action="{{ url_for('bookme_request_status', req_id=req.id) }}">
                <input type="hidden" name="action" value="cancel" />
                <button class="btn btn-secondary" type="submit">Cancel request</button>
              </form>
            {% else %}
              <a class="btn btn-secondary" href="{{ url_for('booking_detail', booking_id=req.booking_id) if req.booking_id else url_for('bookme_requests') }}">View</a>
            {% endif %}
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty-state">No sent requests yet.</p>
    {% endif %}
  </div>

  <div class="bf-list is-hidden" data-tab="bookings" data-segment="incoming">
    {% if provider_bookings %}
      {% for booking in provider_bookings %}
        {% set meta = booking_payment_meta.get(booking.id, {}) %}
        {% set deposit_paid = meta.get('deposit_paid', False) %}
        {% set remaining_base = meta.get('remaining_base_cents') %}
        {% set status_value = (booking.status or 'pending')|lower %}
        {% set needs_action = (booking.status == 'accepted' and not booking.quoted_total_cents) %}
        <article class="bf-row-card {% if needs_action %}needs-action{% endif %}" data-status="{{ status_value }}" data-search="{{ booking.client.username }} {{ booking.event_datetime or '' }}">
          <div class="bf-row-main">
            <div class="bf-row-title">{{ booking.event_title }}</div>
            <div class="bf-row-meta">
              <span class="bf-badge status-{{ status_value }}">{{ status_value.title() }}</span>
              <span>@{{ booking.client.username }}</span>
              <span>
                {% if booking.event_datetime %}
                  {{ booking.event_datetime.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  Date not set
                {% endif %}
              </span>
              {% if booking.duration_minutes %}
                <span>{{ '%.2f'|format(booking.duration_minutes / 60.0) }} hrs</span>
              {% endif %}
            </div>
            {% if booking.quoted_total_cents %}
              <div class="bf-row-note">Total: ${{ '%.2f'|format(booking.quoted_total_cents / 100.0) }}</div>
            {% endif %}
          </div>
          <div class="bf-row-side">
            <div class="bf-row-badges">
              <span class="bf-pill">Deposit: {{ "Paid" if deposit_paid else "Due" }}</span>
              <span class="bf-pill">Balance: {{ "Due" if remaining_base and remaining_base > 0 else "Paid" if remaining_base == 0 else "Pending" }}</span>
            </div>
            <a class="btn btn-secondary" href="{{ url_for('booking_detail', booking_id=booking.id) }}">View details</a>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty-state">No bookings as provider yet.</p>
    {% endif %}
  </div>

  <div class="bf-list is-hidden" data-tab="bookings" data-segment="sent">
    {% if client_bookings %}
      {% for booking in client_bookings %}
        {% set meta = booking_payment_meta.get(booking.id, {}) %}
        {% set deposit_paid = meta.get('deposit_paid', False) %}
        {% set remaining_base = meta.get('remaining_base_cents') %}
        {% set status_value = (booking.status or 'pending')|lower %}
        <article class="bf-row-card" data-status="{{ status_value }}" data-search="{{ booking.provider.username }} {{ booking.event_datetime or '' }}">
          <div class="bf-row-main">
            <div class="bf-row-title">{{ booking.event_title }}</div>
            <div class="bf-row-meta">
              <span class="bf-badge status-{{ status_value }}">{{ status_value.title() }}</span>
              <span>@{{ booking.provider.username }}</span>
              <span>
                {% if booking.event_datetime %}
                  {{ booking.event_datetime.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  Date not set
                {% endif %}
              </span>
              {% if booking.duration_minutes %}
                <span>{{ '%.2f'|format(booking.duration_minutes / 60.0) }} hrs</span>
              {% endif %}
            </div>
            {% if booking.quoted_total_cents %}
              <div class="bf-row-note">Total: ${{ '%.2f'|format(booking.quoted_total_cents / 100.0) }}</div>
            {% endif %}
          </div>
          <div class="bf-row-side">
            <div class="bf-row-badges">
              <span class="bf-pill">Deposit: {{ "Paid" if deposit_paid else "Due" }}</span>
              <span class="bf-pill">Balance: {{ "Due" if remaining_base and remaining_base > 0 else "Paid" if remaining_base == 0 else "Pending" }}</span>
            </div>
            <a class="btn btn-secondary" href="{{ url_for('booking_detail', booking_id=booking.id) }}">View details</a>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="empty-state">No bookings as client yet.</p>
    {% endif %}
  </div>

  <section class="hold-fee-note">
    <strong>Note:</strong> Accepting a BookMe request reserves a ${{ '%.2f'|format(HOLD_FEE_CENTS / 100.0) }} hold fee plus applicable fees.
  </section>
</div>

<div class="bf-modal is-hidden" id="hold-fee-modal">
  <div class="bf-modal-overlay" data-close="true"></div>
  <div class="bf-modal-body">
    <div class="bf-modal-header">
      <h3>Pay hold fee</h3>
      <button class="bf-icon-btn" type="button" data-close="true">Close</button>
    </div>
    <div class="bf-modal-content">
      <p class="bf-modal-text">
        Your hold fee reserves the session and is credited toward the service.
        Processing fees are non-refundable. BeatFund service fee applies when you pay the remaining balance.
      </p>
      <div class="bf-breakdown">
        <div class="bf-break-row">
          <span>Hold amount (credited)</span>
          <strong id="hold-fee-base">${{ '%.2f'|format(HOLD_FEE_CENTS / 100.0) }}</strong>
        </div>
        <div class="bf-break-row">
          <span>Payment processing fee (non-refundable)</span>
          <strong id="holdProcFee">Loading...</strong>
        </div>
        <div class="bf-break-row total">
          <span>Total due now</span>
          <strong id="holdTotalDue">${{ '%.2f'|format(HOLD_FEE_CENTS / 100.0) }}</strong>
        </div>
      </div>
      <div class="bf-refund-note">BeatFund service fee (5.17%) applies when you pay the remaining balance. Processing fees are non-refundable.</div>
      <div id="stripe-payment-element"></div>
      <div id="holdError" class="bf-error"></div>
    </div>
    <div class="bf-modal-actions">
      <button class="btn btn-primary" type="button" id="holdPayBtn" disabled>Pay</button>
      <button class="btn btn-secondary" type="button" data-close="true">Cancel</button>
    </div>
  </div>
</div>

<style>
  .bookme-requests-page {
    max-width: 1100px;
    margin: 0 auto;
    padding-bottom: calc(100px + env(safe-area-inset-bottom));
  }
  .summary-strip {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 0.75rem;
    margin-top: 1rem;
  }
  .summary-pill {
    background: #050b1a;
    border: 1px solid rgba(148, 163, 184, 0.25);
    border-radius: 12px;
    padding: 0.65rem 0.85rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
  }
  .bf-toolbar {
    margin-top: 1.5rem;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }
  .bf-tabs {
    display: inline-flex;
    gap: 0.5rem;
  }
  .bf-tab {
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(15, 23, 42, 0.85);
    color: #e2e8f0;
    padding: 0.4rem 0.9rem;
    border-radius: 999px;
    cursor: pointer;
  }
  .bf-tab.is-active {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-color: transparent;
    color: #fff;
  }
  .bf-filters {
    display: flex;
    gap: 0.6rem;
  }
  .bf-filters input,
  .bf-filters select {
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 10px;
    padding: 0.4rem 0.6rem;
    color: #e2e8f0;
    font-size: 0.85rem;
  }
  .bf-segmented {
    margin-top: 1rem;
    display: inline-flex;
    gap: 0.4rem;
    background: rgba(15, 23, 42, 0.7);
    border: 1px solid rgba(148, 163, 184, 0.25);
    padding: 0.25rem;
    border-radius: 999px;
  }
  .bf-seg {
    border: none;
    background: transparent;
    color: #cbd5f5;
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .bf-seg.is-active {
    background: rgba(59, 130, 246, 0.2);
    color: #e2e8f0;
  }
  .bf-list {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .bf-row-card {
    background: #050b1a;
    border-radius: 14px;
    border: 1px solid rgba(30, 64, 175, 0.35);
    padding: 0.9rem 1rem;
    display: flex;
    justify-content: space-between;
    gap: 1rem;
  }
  .bf-row-card.needs-action {
    border-color: rgba(251, 191, 36, 0.6);
    box-shadow: 0 0 0 1px rgba(251, 191, 36, 0.2);
  }
  .bf-row-title {
    font-weight: 600;
    font-size: 1rem;
  }
  .bf-row-meta {
    margin-top: 0.2rem;
    font-size: 0.8rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    opacity: 0.85;
  }
  .bf-row-note {
    margin-top: 0.35rem;
    font-size: 0.82rem;
    opacity: 0.85;
  }
  .bf-row-side {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
    min-width: 180px;
  }
  .bf-row-badges {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .bf-pill {
    background: rgba(148, 163, 184, 0.18);
    border-radius: 999px;
    padding: 0.2rem 0.6rem;
    font-size: 0.72rem;
    text-align: right;
  }
  .bf-badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .status-pending {
    background: rgba(251, 191, 36, 0.15);
    color: #facc15;
  }
  .status-accepted,
  .status-confirmed {
    background: rgba(34, 197, 94, 0.15);
    color: #4ade80;
  }
  .status-quoted {
    background: rgba(59, 130, 246, 0.18);
    color: #93c5fd;
  }
  .status-declined,
  .status-cancelled,
  .status-canceled {
    background: rgba(239, 68, 68, 0.15);
    color: #fca5a5;
  }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    padding: 0.3rem 0.9rem;
    font-size: 0.78rem;
    border: none;
    cursor: pointer;
    text-decoration: none;
  }
  .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: #fff;
  }
  .btn-secondary {
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
    border: 1px solid rgba(148, 163, 184, 0.4);
  }
  .btn-disabled {
    background: rgba(51, 65, 85, 0.6);
    color: rgba(148, 163, 184, 0.9);
    cursor: default;
  }
  .empty-state {
    opacity: 0.8;
  }
  .hold-fee-note {
    margin-top: 1.5rem;
    font-size: 0.8rem;
    opacity: 0.8;
  }
  .is-hidden {
    display: none;
  }
  .bf-modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .bf-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(2, 6, 23, 0.7);
  }
  .bf-modal-body {
    position: relative;
    background: #0b1324;
    border-radius: 16px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    padding: 1rem;
    width: min(500px, 92vw);
    z-index: 1;
  }
  .bf-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  .bf-icon-btn {
    background: transparent;
    border: none;
    color: #cbd5f5;
    cursor: pointer;
  }
  .bf-modal-content {
    margin-bottom: 1rem;
  }
  .bf-modal-text {
    font-size: 0.85rem;
    opacity: 0.85;
    margin-bottom: 0.75rem;
  }
  .bf-breakdown {
    border: 1px solid rgba(148, 163, 184, 0.25);
    border-radius: 12px;
    padding: 0.7rem 0.8rem;
    background: rgba(2, 6, 23, 0.4);
    margin-bottom: 0.75rem;
  }
  .bf-break-row {
    display: flex;
    justify-content: space-between;
    font-size: 0.82rem;
    margin-bottom: 0.35rem;
  }
  .bf-break-row.total {
    border-top: 1px solid rgba(148, 163, 184, 0.2);
    padding-top: 0.35rem;
    margin-bottom: 0;
    font-weight: 600;
  }
  .bf-refund-note {
    font-size: 0.75rem;
    opacity: 0.75;
    margin-bottom: 0.75rem;
  }
  .bf-modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  .bf-error {
    color: #fca5a5;
    font-size: 0.8rem;
    margin-top: 0.5rem;
  }
  @media (max-width: 900px) {
    .summary-strip {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .bf-row-card {
      flex-direction: column;
      align-items: flex-start;
    }
    .bf-row-side {
      align-items: flex-start;
    }
  }
  @media (max-width: 600px) {
    .summary-strip {
      grid-template-columns: 1fr;
    }
    .bf-toolbar {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>

{% if stripe_enabled %}
<script src="https://js.stripe.com/v3/"></script>
{% endif %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.bf-tab');
    const segButtons = document.querySelectorAll('.bf-seg');
    const segmentGroups = document.querySelectorAll('.bf-segmented');
    const lists = document.querySelectorAll('.bf-list');
    const statusFilter = document.getElementById('bf-status-filter');
    const searchInput = document.getElementById('bf-search');

    function showList(tab, segment) {
      lists.forEach(list => {
        const match = list.dataset.tab === tab && list.dataset.segment === segment;
        list.classList.toggle('is-hidden', !match);
      });
      segmentGroups.forEach(group => {
        group.classList.toggle('is-hidden', group.dataset.tab !== tab);
      });
      updateFilters();
    }

    function updateFilters() {
      const activeList = document.querySelector('.bf-list:not(.is-hidden)');
      if (!activeList) return;
      const statusVal = statusFilter ? statusFilter.value : 'all';
      const searchVal = (searchInput ? searchInput.value : '').toLowerCase().trim();
      activeList.querySelectorAll('.bf-row-card').forEach(card => {
        const status = (card.dataset.status || '').toLowerCase();
        const search = (card.dataset.search || '').toLowerCase();
        const statusOk = statusVal === 'all' || status === statusVal;
        const searchOk = !searchVal || search.includes(searchVal);
        card.style.display = (statusOk && searchOk) ? '' : 'none';
      });
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('is-active'));
        tab.classList.add('is-active');
        const tabVal = tab.dataset.tab;
        const group = document.querySelector(`.bf-segmented[data-tab="${tabVal}"]`);
        const firstSeg = group ? group.querySelector('.bf-seg') : null;
        if (firstSeg) {
          group.querySelectorAll('.bf-seg').forEach(seg => seg.classList.remove('is-active'));
          firstSeg.classList.add('is-active');
          showList(tabVal, firstSeg.dataset.segment);
        }
      });
    });

    segButtons.forEach(seg => {
      seg.addEventListener('click', () => {
        const group = seg.closest('.bf-segmented');
        if (!group) return;
        group.querySelectorAll('.bf-seg').forEach(s => s.classList.remove('is-active'));
        seg.classList.add('is-active');
        const tabVal = group.dataset.tab;
        showList(tabVal, seg.dataset.segment);
      });
    });

    if (statusFilter) statusFilter.addEventListener('change', updateFilters);
    if (searchInput) searchInput.addEventListener('input', updateFilters);
    showList('requests', 'incoming');

    const stripeEnabled = {{ 'true' if stripe_enabled else 'false' }};
    if (!stripeEnabled) return;
    const stripe = Stripe({{ stripe_publishable_key|tojson }});
    const modal = document.getElementById('hold-fee-modal');
    const elementContainer = document.getElementById('stripe-payment-element');
    const errorEl = document.getElementById('holdError');
    const confirmBtn = document.getElementById('holdPayBtn');
    const baseEl = document.getElementById('hold-fee-base');
    const processingEl = document.getElementById('holdProcFee');
    const totalEl = document.getElementById('holdTotalDue');
    const closeButtons = modal ? modal.querySelectorAll('[data-close]') : [];
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    let elements = null;
    let paymentElement = null;
    const holdDefault = {{ ('%.2f'|format(HOLD_FEE_CENTS / 100.0))|tojson }};

    function formatCents(cents) {
      const value = Number(cents || 0) / 100;
      return `$${value.toFixed(2)}`;
    }

    function resetModal() {
      if (paymentElement) {
        paymentElement.unmount();
        paymentElement = null;
      }
      elements = null;
      if (elementContainer) elementContainer.innerHTML = '';
      if (errorEl) errorEl.textContent = '';
      if (baseEl) baseEl.textContent = `$${holdDefault}`;
      if (processingEl) processingEl.textContent = 'Loading...';
      if (totalEl) totalEl.textContent = `$${holdDefault}`;
      if (confirmBtn) {
        confirmBtn.textContent = 'Pay';
        confirmBtn.disabled = true;
      }
    }

    function openModal() {
      if (modal) modal.classList.remove('is-hidden');
    }

    function closeModal() {
      if (modal) modal.classList.add('is-hidden');
      resetModal();
    }

    closeButtons.forEach(btn => {
      btn.addEventListener('click', closeModal);
    });

    async function startHoldFeePayment(bookingId, button) {
      if (!bookingId || !csrfToken) return;
      const original = button.textContent;
      button.disabled = true;
      button.textContent = 'Starting...';
      resetModal();
      openModal();
      try {
        const resp = await fetch(`/api/bookings/${bookingId}/pay/deposit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({kind: 'deposit'})
        });
        const data = await resp.json();
        if (!resp.ok) {
          if (data.error === 'deposit_already_paid') {
            if (errorEl) errorEl.textContent = 'Deposit already paid. Reloading...';
            setTimeout(() => window.location.reload(), 800);
            return;
          }
          throw new Error(data.error || 'Unable to start payment');
        }
        const breakdown = data.breakdown || {};
        const baseCents = (breakdown.hold_base_cents ?? breakdown.base_cents ?? 0);
        const procCents = (breakdown.processing_fee_cents ?? 0);
        const totalCents = (breakdown.total_cents ?? 0);
        if (baseEl) baseEl.textContent = formatCents(baseCents);
        if (processingEl) processingEl.textContent = formatCents(procCents);
        if (totalEl) totalEl.textContent = formatCents(totalCents);
        if (confirmBtn) confirmBtn.textContent = `Pay ${formatCents(totalCents)}`;

        elements = stripe.elements({clientSecret: data.client_secret});
        paymentElement = elements.create('payment');
        paymentElement.mount('#stripe-payment-element');
        if (confirmBtn) confirmBtn.disabled = false;
        confirmBtn.onclick = async () => {
          confirmBtn.disabled = true;
          const result = await stripe.confirmPayment({
            elements,
            confirmParams: {
              return_url: `${window.location.origin}/bookme/requests`
            }
          });
          if (result.error) {
            if (errorEl) errorEl.textContent = result.error.message || 'Payment failed.';
            confirmBtn.disabled = false;
          }
        };
      } catch (err) {
        if (errorEl) errorEl.textContent = err.message;
        if (confirmBtn) confirmBtn.disabled = true;
      } finally {
        button.disabled = false;
        button.textContent = original;
      }
    }

    document.querySelectorAll('.pay-hold-fee-btn').forEach(btn => {
      btn.addEventListener('click', () => startHoldFeePayment(btn.dataset.bookingId, btn));
    });
  });
</script>
{% endblock %}
