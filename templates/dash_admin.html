{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<style>
  .admin-shell {
    padding-top: 1.5rem;
    padding-bottom: 2rem;
  }

  .admin-shell h1 {
    font-size: 1.8rem;
    font-weight: 600;
  }

  .admin-subtitle {
    font-size: 0.9rem;
    opacity: 0.8;
  }

  .stat-card {
    background: linear-gradient(135deg, rgba(16,24,40,0.96), rgba(15,23,42,0.98));
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    padding: 1rem 1.1rem;
    color: #e5e7eb;
    box-shadow: 0 18px 35px rgba(15,23,42,0.6);
    position: relative;
    overflow: hidden;
  }

  .stat-card::after {
    content: "";
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at top right, rgba(59,130,246,0.35), transparent 55%);
    opacity: 0.7;
    pointer-events: none;
    mix-blend-mode: screen;
  }

  .stat-card .label {
    font-size: 0.78rem;
    letter-spacing: .12em;
    text-transform: uppercase;
    opacity: .7;
    margin-bottom: .15rem;
  }

  .stat-card .value {
    font-size: 2rem;
    font-weight: 600;
    line-height: 1.1;
  }

  .stat-card .meta {
    font-size: 0.8rem;
    opacity: 0.85;
  }

  .stat-icon {
    width: 2.35rem;
    height: 2.35rem;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin-right: 0.6rem;
    background: rgba(15,23,42,0.8);
    border: 1px solid rgba(148, 163, 184, 0.45);
    z-index: 1;
  }

  .section-title {
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: .18em;
    opacity: .7;
    margin-bottom: .5rem;
  }

  .card-surface {
    background: rgba(15,23,42,0.9);
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.25);
    color: #e5e7eb;
  }

  .card-surface .card-header {
    background: transparent;
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    padding: .75rem 1rem;
  }

  .card-surface .card-body {
    padding: .85rem 1rem 1rem;
  }

  .admin-link {
    color: #93c5fd;
    text-decoration: none;
  }
  .admin-link:hover {
    color: #bfdbfe;
    text-decoration: underline;
  }

  .timeline {
    border-left: 1px solid rgba(148, 163, 184, 0.55);
    margin-left: .4rem;
    padding-left: 1.1rem;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 0.85rem;
  }

  .timeline-item::before {
    content: "";
    position: absolute;
    left: -1.05rem;
    top: .35rem;
    width: .55rem;
    height: .55rem;
    background: #38bdf8;
    border-radius: 999px;
    box-shadow: 0 0 0 3px rgba(56,189,248,0.35);
  }

  .timeline-title {
    font-size: 0.82rem;
    font-weight: 500;
  }

  .timeline-meta {
    font-size: 0.74rem;
    opacity: 0.75;
  }

  .shortcut-pill {
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.45);
    padding: 0.45rem 0.8rem;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    background: rgba(15,23,42,0.85);
    margin: 0.2rem 0.25rem 0.2rem 0;
  }

  .shortcut-pill:hover {
    text-decoration: none;
    border-color: #60a5fa;
    color: #dbeafe;
  }

  .badge-soft {
    font-size: 0.65rem;
    border-radius: 999px;
    padding: 0.18rem 0.55rem;
    text-transform: uppercase;
    letter-spacing: .1em;
  }

  .badge-soft-success {
    background: rgba(34,197,94,0.18);
    color: #bbf7d0;
    border: 1px solid rgba(34,197,94,0.55);
  }

  .badge-soft-warning {
    background: rgba(250,204,21,0.16);
    color: #fef3c7;
    border: 1px solid rgba(250,204,21,0.55);
  }

  .badge-soft-danger {
    background: rgba(248,113,113,0.15);
    color: #fee2e2;
    border: 1px solid rgba(248,113,113,0.55);
  }

  /* small screens */
  @media (max-width: 767.98px) {
    .stat-card {
      margin-bottom: .75rem;
    }
  }
</style>

<div class="container admin-shell">

  <!-- Header -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4">
    <div>
      <h1 class="mb-1">Admin Dashboard</h1>
      <div class="admin-subtitle">
        Oversight for users, wallets, marketplace activity, KYC and support.
      </div>
    </div>

    {% if current_user.is_authenticated and current_user.is_superadmin %}
      <div class="mt-3 mt-md-0 d-flex align-items-center gap-2">
        <span class="badge-soft badge-soft-warning">Superadmin</span>
        <a href="{{ url_for('superadmin_unlock') }}"
           class="btn btn-sm btn-outline-warning">
          üîê Open Owner Panel
        </a>
      </div>
    {% endif %}
  </div>

  <!-- Stat cards row -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
      <div class="stat-card h-100">
        <div class="d-flex align-items-center mb-2 position-relative" style="z-index:1;">
          <div class="stat-icon">üë§</div>
          <div>
            <div class="label">Users</div>
            <div class="value">{{ total_users }}</div>
          </div>
        </div>
        <div class="meta position-relative" style="z-index:1;">
          Non-admin accounts currently registered.
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="stat-card h-100">
        <div class="d-flex align-items-center mb-2 position-relative" style="z-index:1;">
          <div class="stat-icon">üíº</div>
          <div>
            <div class="label">Wallets</div>
            <div class="value">{{ total_wallets }}</div>
          </div>
        </div>
        <div class="meta position-relative" style="z-index:1;">
          User wallets created and active on the platform.
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="stat-card h-100">
        <div class="d-flex align-items-center mb-2 position-relative" style="z-index:1;">
          <div class="stat-icon">üéß</div>
          <div>
            <div class="label">Beats</div>
            <div class="value">{{ total_beats }}</div>
          </div>
        </div>
        <div class="meta position-relative" style="z-index:1;">
          Total beats listed and available in the catalog.
        </div>
      </div>
    </div>

    <div class="col-6 col-lg-3">
      <div class="stat-card h-100">
        <div class="d-flex align-items-center mb-2 position-relative" style="z-index:1;">
          <div class="stat-icon">üí≥</div>
          <div>
            <div class="label">Orders</div>
            <div class="value">{{ total_orders }}</div>
          </div>
        </div>
        <div class="meta position-relative" style="z-index:1;">
          Completed orders processed through BeatFund.
        </div>
      </div>
    </div>
  </div>

  <!-- Second row: KYC / user mix / tickets -->
  <div class="row g-3 mb-4">
    <!-- KYC -->
    <div class="col-md-4">
      <div class="card card-surface h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="section-title mb-0">KYC Queue</span>
          <a href="{{ url_for('admin_kyc') }}" class="admin-link small">Open KYC view ‚Üí</a>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small">Pending</span>
            <span class="badge-soft badge-soft-warning">{{ pending_kyc }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small">Approved</span>
            <span class="badge-soft badge-soft-success">{{ approved_kyc }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small">Rejected</span>
            <span class="badge-soft badge-soft-danger">{{ rejected_kyc }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- User mix -->
    <div class="col-md-4">
      <div class="card card-surface h-100">
        <div class="card-header">
          <span class="section-title mb-0">User Mix</span>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between small mb-2">
            <span>Artists</span>
            <span class="fw-semibold">{{ total_artists }}</span>
          </div>
          <div class="d-flex justify-content-between small mb-2">
            <span>Producers</span>
            <span class="fw-semibold">{{ total_producers }}</span>
          </div>
          <div class="mt-3">
            <canvas id="roleChart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Tickets -->
    <div class="col-md-4">
      <div class="card card-surface h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="section-title mb-0">Support Tickets</span>
          <a href="{{ url_for('admin_tickets') }}" class="admin-link small">View tickets ‚Üí</a>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between small mb-1">
            <span>Total</span>
            <span class="fw-semibold">{{ total_tickets }}</span>
          </div>
          <div class="d-flex justify-content-between small mb-1">
            <span>Open</span>
            <span class="fw-semibold text-warning">{{ open_tickets }}</span>
          </div>
          <div class="d-flex justify-content-between small mb-1">
            <span>In Review</span>
            <span class="fw-semibold text-info">{{ in_review_tickets }}</span>
          </div>
          <div class="d-flex justify-content-between small">
            <span>Resolved / Closed</span>
            <span class="fw-semibold text-success">{{ resolved_tickets }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Third row: shortcuts + activity -->
  <div class="row g-3">
    <!-- Admin shortcuts -->
    <div class="col-lg-4">
      <div class="card card-surface h-100">
        <div class="card-header">
          <span class="section-title mb-0">Admin Tools</span>
        </div>
        <div class="card-body">
          <div class="mb-2 small text-muted">
            Quick access to the core admin areas.
          </div>
          <div>
            <a class="shortcut-pill admin-link" href="{{ url_for('admin_users') }}">
              üë• <span>Manage Users</span>
            </a>
            <a class="shortcut-pill admin-link" href="{{ url_for('admin_kyc') }}">
              ‚úÖ <span>KYC Review</span>
            </a>
            <a class="shortcut-pill admin-link" href="{{ url_for('admin_transactions') }}">
              üí≥ <span>Transactions &amp; Audit</span>
            </a>
            <a class="shortcut-pill admin-link" href="{{ url_for('admin_reports') }}">
              üìä <span>Financial Reports</span>
            </a>
            <a class="shortcut-pill admin-link" href="{{ url_for('admin_bookme') }}">
              üìÖ <span>BookMe Admin</span>
            </a>
            <a class="shortcut-pill admin-link" href="{{ url_for('admin_team') }}">
              üõ†Ô∏è <span>Admin Team</span>
            </a>
          </div>

          {% if current_user.is_authenticated and current_user.is_superadmin %}
            <hr class="border-secondary mt-3 mb-2">
            <div class="small text-muted mb-1">Superadmin</div>
            <a href="{{ url_for('superadmin_unlock') }}"
               class="shortcut-pill admin-link">
              üîê <span>Owner Wallet Panel</span>
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Recent activity -->
    <div class="col-lg-8">
      <div class="card card-surface h-100">
        <div class="card-header">
          <span class="section-title mb-0">Recent Activity</span>
        </div>
        <div class="card-body">
          {% if recent_events %}
            <div class="timeline mt-1">
              {% for ev in recent_events %}
                <div class="timeline-item">
                  <div class="timeline-title">
                    {{ ev.title }}
                  </div>
                  <div class="timeline-meta">
                    {{ ev.body }}
                    {% if ev.ts %}
                      ¬∑ {{ ev.ts.strftime("%Y-%m-%d %H:%M") }}
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="small text-muted mb-0">
              No recent audit or ticket events have been recorded yet.
            </p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Lightweight chart for user roles -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  (function () {
    const ctx = document.getElementById('roleChart');
    if (!ctx) return;

    const totalArtists = {{ total_artists or 0 }};
    const totalProducers = {{ total_producers or 0 }};
    const others = Math.max({{ total_users or 0 }} - (totalArtists + totalProducers), 0);

    const data = {
      labels: ['Artists', 'Producers', 'Other Roles'],
      datasets: [{
        data: [totalArtists, totalProducers, others],
        borderWidth: 0,
        backgroundColor: [
          'rgba(96, 165, 250, 0.9)',   // blue
          'rgba(52, 211, 153, 0.9)',   // green
          'rgba(251, 191, 36, 0.9)'    // amber
        ],
        hoverBackgroundColor: [
          'rgba(147, 197, 253, 1)',
          'rgba(110, 231, 183, 1)',
          'rgba(252, 211, 77, 1)'
        ]
      }]
    };

    new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#e5e7eb',
              font: { size: 10 }
            }
          }
        },
        cutout: '60%'
      }
    });
  })();
</script>
{% endblock %}
