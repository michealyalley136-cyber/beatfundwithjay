{% extends "base.html" %}
{% block title %}Artist Dashboard · BeatFund{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  .bf-artist { max-width: 1100px; margin: 0 auto; padding: 16px; }
  .bf-hero { display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .bf-hero-left { display:flex; gap:12px; align-items:center; min-width: 260px; }
  .bf-avatar { width: 48px; height: 48px; border-radius: 14px; object-fit: cover; border: 1px solid rgba(255,255,255,.12); }
  .bf-title { margin:0; font-size: 1.25rem; line-height: 1.2; }
  .bf-sub { margin:4px 0 0; opacity:.8; font-size: .95rem; }
  .bf-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

  .bf-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-top: 14px; }
  .bf-card { border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); border-radius: 18px; padding: 14px; }
  .bf-card h3 { margin:0 0 10px; font-size: 1.05rem; }
  .bf-kpis { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
  .bf-kpi { padding: 12px; border-radius: 16px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); }
  .bf-kpi .label { opacity:.75; font-size: .9rem; }
  .bf-kpi .value { margin-top: 6px; font-size: 1.25rem; font-weight: 700; }
  .bf-kpi .hint { opacity:.7; font-size: .85rem; margin-top: 4px; }

  .bf-btn {
    display:inline-flex; align-items:center; justify-content:center;
    padding: 10px 12px; border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.08);
    text-decoration:none;
    font-weight: 600;
    min-height: 40px;
  }
  .bf-btn.primary { background: rgba(124,58,237,.25); border-color: rgba(124,58,237,.45); }
  .bf-btn.block { width: 100%; }

  .bf-list { display:flex; flex-direction:column; gap:10px; }
  .bf-row { display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
  .bf-row .left { min-width: 220px; }
  .bf-row .meta { opacity:.75; font-size:.9rem; }
  .bf-chip {
    display:inline-flex; align-items:center;
    padding: 6px 10px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size: .85rem; opacity:.9;
  }

  .span-12 { grid-column: span 12; }
  .span-7 { grid-column: span 12; }
  .span-5 { grid-column: span 12; }

  @media (min-width: 900px){
    .span-7 { grid-column: span 7; }
    .span-5 { grid-column: span 5; }
  }

  /* make tables (if any) scroll instead of squeezing */
  .bf-scroll { overflow-x:auto; -webkit-overflow-scrolling: touch; }
</style>
{% endblock %}

{% block content %}
<div class="bf-artist">

  <div class="bf-hero">
    <div class="bf-hero-left">
      <img class="bf-avatar" src="{{ current_user.avatar_url }}" alt="avatar">
      <div>
        <h1 class="bf-title">Welcome, {{ current_user.display_name }}</h1>
        <p class="bf-sub">{{ role_label }} · @{{ current_user.username }}</p>
      </div>
    </div>

    <div class="bf-actions">
      <a class="bf-btn primary" href="{{ url_for('wallet_home') }}">Wallet</a>
      <a class="bf-btn" href="{{ url_for('bookme_search') }}">Find Providers</a>
      <a class="bf-btn" href="{{ url_for('bookme_requests') }}">Requests</a>
      <a class="bf-btn" href="{{ url_for('profile_edit') }}">Edit Profile</a>
    </div>
  </div>

  <div class="bf-grid">

    <div class="bf-card span-12">
      <div class="bf-kpis">
        <div class="bf-kpi">
          <div class="label">Followers</div>
          <div class="value">{{ followers_count }}</div>
          <div class="hint">People following you</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Following</div>
          <div class="value">{{ following_count }}</div>
          <div class="hint">People you follow</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Wallet Balance</div>
          <div class="value">${{ '%.2f'|format(wallet_balance or 0) }}</div>
          <div class="hint">Tap Wallet to fund & track</div>
        </div>
        <div class="bf-kpi">
          <div class="label">BookMe Requests</div>
          <div class="value">{{ incoming_requests_count }}</div>
          <div class="hint">Pending requests to you</div>
        </div>
      </div>
    </div>

    <div class="bf-card span-7">
      <h3>Incoming Booking Requests</h3>
      {% if incoming_requests and incoming_requests|length %}
        <div class="bf-list">
          {% for r in incoming_requests %}
            <div class="bf-row">
              <div class="left">
                <div><strong>@{{ r.client.username }}</strong> <span class="bf-chip">{{ r.status.value }}</span></div>
                <div class="meta">{{ r.preferred_time }}</div>
                {% if r.message %}<div class="meta">{{ r.message }}</div>{% endif %}
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap;">
                <form method="post" action="{{ url_for('bookme_request_status', req_id=r.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="action" value="accept">
                  <button class="bf-btn primary" type="submit">Accept</button>
                </form>
                <form method="post" action="{{ url_for('bookme_request_status', req_id=r.id) }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="action" value="decline">
                  <button class="bf-btn" type="submit">Decline</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
        <div style="margin-top:12px;">
          <a class="bf-btn block" href="{{ url_for('bookme_requests') }}">View All Requests</a>
        </div>
      {% else %}
        <p class="meta">No pending requests right now.</p>
      {% endif %}
    </div>

    <div class="bf-card span-5">
      <h3>Quick Setup</h3>
      <div class="bf-list">
        <a class="bf-btn block" href="{{ url_for('bookme_profile') }}">
          {% if prof %}Edit BookMe Profile{% else %}Create BookMe Profile{% endif %}
        </a>
        <a class="bf-btn block" href="{{ url_for('bookme_portfolio') }}">
          Portfolio ({{ portfolio_count or 0 }})
        </a>
        <a class="bf-btn block" href="{{ url_for('market_index') }}">Marketplace</a>
      </div>
    </div>

    <div class="bf-card span-7">
      <h3>Upcoming (You as Provider)</h3>
      {% if upcoming_as_provider and upcoming_as_provider|length %}
        <div class="bf-list">
          {% for b in upcoming_as_provider %}
            <div class="bf-row">
              <div class="left">
                <div><strong>{{ b.event_title }}</strong> <span class="bf-chip">{{ b.status }}</span></div>
                <div class="meta">{{ b.event_datetime }}</div>
                <div class="meta">Client: @{{ b.client.username }}</div>
              </div>
              <div>
                <a class="bf-btn" href="{{ url_for('booking_detail', booking_id=b.id) }}">Open</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="meta">No upcoming bookings where you’re the provider.</p>
      {% endif %}
    </div>

    <div class="bf-card span-5">
      <h3>Recent Wallet Activity</h3>
      {% if recent_txns and recent_txns|length %}
        <div class="bf-list">
          {% for t in recent_txns %}
            <div class="bf-row">
              <div class="left">
                <div><strong>{{ t.entry_type.value }}</strong></div>
                <div class="meta">{{ t.created_at }}</div>
                {% if t.meta %}<div class="meta">{{ t.meta }}</div>{% endif %}
              </div>
              <div class="bf-chip">${{ '%.2f'|format((t.amount_cents or 0)/100) }}</div>
            </div>
          {% endfor %}
        </div>
        <div style="margin-top:12px;">
          <a class="bf-btn block" href="{{ url_for('wallet_home', tab='transactions') }}">View Transactions</a>
        </div>
      {% else %}
        <p class="meta">No transactions yet.</p>
        <a class="bf-btn block primary" href="{{ url_for('wallet_home') }}">Fund Wallet</a>
      {% endif %}
    </div>

    <div class="bf-card span-12">
      <h3>Recent Activity</h3>
      {% if recent_bookings and recent_bookings|length %}
        <div class="bf-list">
          {% for b in recent_bookings %}
            <div class="bf-row">
              <div class="left">
                <div><strong>{{ b.event_title }}</strong> <span class="bf-chip">{{ b.status }}</span></div>
                <div class="meta">{{ b.created_at }}</div>
              </div>
              <div>
                <a class="bf-btn" href="{{ url_for('booking_detail', booking_id=b.id) }}">Open</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="meta">No recent activity yet.</p>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
