{% extends "base.html" %}
{% block title %}Request Booking · BeatFund{% endblock %}

{% block content %}
<style>
  .pb-page{max-width:980px;margin:0 auto;padding:28px 16px 64px;color:#f7f9ff;}
  .pb-card{background:radial-gradient(circle at top left,#182a44,#050712);border-radius:18px;border:1px solid rgba(255,255,255,.08);padding:18px 20px 20px;box-shadow:0 16px 40px rgba(0,0,0,.45);}
  .pb-header{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:14px;}
  .pb-left{display:flex;align-items:center;gap:12px;min-width:260px;}
  .pb-avatar{width:46px;height:46px;border-radius:14px;object-fit:cover;border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.9);}
  .pb-title{margin:0;font-size:1.05rem;line-height:1.2;}
  .pb-sub{margin:2px 0 0;font-size:.85rem;opacity:.82;}
  .pb-tag{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
  .pb-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .pb-btn{border-radius:999px;padding:7px 12px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.35);color:#f9fafb;cursor:pointer;font-size:.85rem;text-decoration:none;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;transition:transform .08s ease,background .12s ease,border-color .12s ease;}
  .pb-btn:hover{background:rgba(148,163,184,.14);border-color:rgba(99,102,241,.7);transform:translateY(-1px);}
  .pb-btn-primary{border-color:rgba(56,189,248,.9);background:radial-gradient(circle at top left,rgba(56,189,248,.22),rgba(15,23,42,.9));}
  .pb-btn-primary:hover{background:radial-gradient(circle at top left,rgba(56,189,248,.35),rgba(15,23,42,1));}
  .pb-btn-danger{border-color:rgba(248,113,113,.8);color:#fecaca;}
  .pb-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
  @media (max-width:860px){.pb-grid{grid-template-columns:1fr;}}
  .pb-field{display:flex;flex-direction:column;gap:5px;}
  .pb-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;opacity:.85;}
  .pb-input,.pb-select,.pb-textarea{width:100%;border-radius:12px;border:1px solid rgba(148,163,184,.28);background:rgba(2,6,23,.55);color:#e5e7eb;padding:10px 12px;outline:none;}
  .pb-textarea{min-height:120px;resize:vertical;}
  .pb-hint{font-size:.82rem;opacity:.75;margin-top:10px;}
  .pb-section{margin-top:14px;padding-top:12px;border-top:1px solid rgba(148,163,184,.18);}
  .pb-section-title{margin:0 0 8px;font-size:.95rem;}
  .pb-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:14px;}
</style>

{% set role_val = (provider.role if provider.role is defined else (provider.role|string))|lower %}

<div class="pb-page">
  <div class="pb-card">
    <div class="pb-header">
      <div class="pb-left">
        <img class="pb-avatar" src="{{ provider.avatar_url }}" alt="{{ provider.username }} avatar">
        <div>
          <h1 class="pb-title">Request booking</h1>
          <div class="pb-sub">
            Provider: <span class="pb-tag">@{{ provider.username }}</span>
            {% if provider.role %} · {{ get_role_display(provider.role) }}{% endif %}
          </div>
          <div class="pb-sub" style="opacity:.7;">
            {{ follower_count }} follower{{ follower_count != 1 and 's' or '' }}
          </div>
        </div>
      </div>

      <div class="pb-actions">
        <a class="pb-btn" href="{{ url_for('provider_portfolio_public', username=provider.username) }}">View profile</a>

        <form method="POST" action="{{ url_for('user_follow_toggle', username=provider.username) }}" style="margin:0;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% if is_following %}
            <button type="submit" class="pb-btn pb-btn-danger">Unfollow</button>
          {% else %}
            <button type="submit" class="pb-btn">Follow</button>
          {% endif %}
        </form>
      </div>
    </div>

    <form method="POST" action="{{ url_for('bookme_book_provider', username=provider.username) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="pb-grid">
        <div class="pb-field">
          <label class="pb-label" for="event_date">Date</label>
          <input class="pb-input" id="event_date" name="event_date" type="date" value="{{ form_data.get('event_date','') }}">
        </div>
        <div class="pb-field">
          <label class="pb-label" for="event_time">Time</label>
          <input class="pb-input" id="event_time" name="event_time" type="time" value="{{ form_data.get('event_time','') }}">
        </div>
      </div>

      <div class="pb-grid">
        <div class="pb-field">
          <label class="pb-label" for="duration_hours">Duration hours (required)</label>
          <input class="pb-input" id="duration_hours" name="duration_hours" type="number" min="0" step="1" value="{{ form_data.get('duration_hours','') }}" required>
        </div>
        <div class="pb-field">
          <label class="pb-label" for="duration_minutes">Duration minutes</label>
          <input class="pb-input" id="duration_minutes" name="duration_minutes" type="number" min="0" max="59" step="1" value="{{ form_data.get('duration_minutes','') }}" placeholder="0">
        </div>
      </div>

      <div class="pb-grid">
        <div class="pb-field">
          <label class="pb-label" for="budget">Budget (optional)</label>
          <input class="pb-input" id="budget" name="budget" type="text" placeholder="e.g. $150/hr or $400 flat" value="{{ form_data.get('budget','') }}">
        </div>
        <div class="pb-field">
          <label class="pb-label" for="preferred_time">Preferred time (fallback)</label>
          <input class="pb-input" id="preferred_time" name="preferred_time" type="text" placeholder="YYYY-MM-DD HH:MM" value="{{ form_data.get('preferred_time','') }}">
        </div>
      </div>

      <div class="pb-section">
        <h3 class="pb-section-title">Availability</h3>
        <div class="pb-hint">
          Accepting new requests: {{ "Yes" if (settings and settings.accepting_new_requests) else "No" }}
        </div>
        <div class="pb-hint">
          Modes:
          {% if settings and settings.onsite %}On-site{% endif %}
          {% if settings and settings.remote %}{% if settings.onsite %} · {% endif %}Remote{% endif %}
          {% if not settings or (not settings.onsite and not settings.remote) %}Not specified{% endif %}
        </div>
        {% if availability_slots %}
          <ul style="margin:8px 0 0; padding-left:18px;">
            {% for s in availability_slots %}
              <li>{{ DAY_NAMES[s.day_of_week] }} · {{ s.start_time.strftime('%H:%M') }} - {{ s.end_time.strftime('%H:%M') }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="pb-hint">No weekly availability set.</div>
        {% endif %}
        {% if availability_exceptions %}
          <div class="pb-hint" style="margin-top:8px;">Exceptions:</div>
          <ul style="margin:6px 0 0; padding-left:18px;">
            {% for e in availability_exceptions %}
              <li>
                {{ e.date }} ·
                {% if e.start_time and e.end_time %}
                  {{ e.start_time.strftime('%H:%M') }} - {{ e.end_time.strftime('%H:%M') }}
                {% else %}
                  All day
                {% endif %}
                ({{ "Unavailable" if e.is_unavailable else "Available" }})
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>

      <div class="pb-section">
        <h3 class="pb-section-title">Project details</h3>

        {% set is_studio = role_val in ["studio"] %}
        {% set is_producer = role_val in ["producer"] %}
        {% set is_mixmaster = role_val in ["mix_master_engineer"] %}
        {% set is_videographer = role_val in ["videographer"] %}
        {% set is_photographer = role_val in ["photographer"] %}
        {% set is_dj = role_val in ["dj"] %}
        {% set is_artist = role_val in ["artist"] %}
        {% set is_event_planner = role_val in ["event_planner"] %}
        {% set is_live_sound = role_val in ["live_sound_engineer"] %}
        {% set is_emcee = role_val in ["emcee_host_hypeman"] %}

        {% if is_studio %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="session_type">Session type</label>
              <select class="pb-select" id="session_type" name="session_type">
                <option value="">Choose…</option>
                <option {% if form_data.get('session_type')=='Recording session' %}selected{% endif %}>Recording session</option>
                <option {% if form_data.get('session_type')=='Vocal tracking' %}selected{% endif %}>Vocal tracking</option>
                <option {% if form_data.get('session_type')=='Rehearsal' %}selected{% endif %}>Rehearsal</option>
                <option {% if form_data.get('session_type')=='Mixing session' %}selected{% endif %}>Mixing session</option>
                <option {% if form_data.get('session_type')=='Mastering session' %}selected{% endif %}>Mastering session</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="people">People attending</label>
              <input class="pb-input" id="people" name="people" type="number" min="1" step="1" value="{{ form_data.get('people','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="engineer_needed">Engineer needed?</label>
              <select class="pb-select" id="engineer_needed" name="engineer_needed">
                <option value="">Choose…</option>
                <option {% if form_data.get('engineer_needed')=='Yes' %}selected{% endif %}>Yes</option>
                <option {% if form_data.get('engineer_needed')=='No' %}selected{% endif %}>No</option>
              </select>
            </div>
          </div>

        {% elif is_producer %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="style">Style / vibe</label>
              <input class="pb-input" id="style" name="style" type="text" value="{{ form_data.get('style','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="deliverables">Deliverables</label>
              <select class="pb-select" id="deliverables" name="deliverables">
                <option value="">Choose…</option>
                <option {% if form_data.get('deliverables')=='Beat only' %}selected{% endif %}>Beat only</option>
                <option {% if form_data.get('deliverables')=='Beat + trackouts' %}selected{% endif %}>Beat + trackouts</option>
                <option {% if form_data.get('deliverables')=='Full production (arrangement)' %}selected{% endif %}>Full production (arrangement)</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="songs"># of songs</label>
              <input class="pb-input" id="songs" name="songs" type="number" min="1" step="1" value="{{ form_data.get('songs','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="deadline">Deadline</label>
              <input class="pb-input" id="deadline" name="deadline" type="text" value="{{ form_data.get('deadline','') }}">
            </div>
          </div>

        {% elif is_mixmaster %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="service">Service</label>
              <select class="pb-select" id="service" name="service">
                <option value="">Choose…</option>
                <option {% if form_data.get('service')=='Mix' %}selected{% endif %}>Mix</option>
                <option {% if form_data.get('service')=='Master' %}selected{% endif %}>Master</option>
                <option {% if form_data.get('service')=='Mix + Master' %}selected{% endif %}>Mix + Master</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="stems">Estimated stems/tracks</label>
              <input class="pb-input" id="stems" name="stems" type="number" min="1" step="1" value="{{ form_data.get('stems','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="format">File format</label>
              <input class="pb-input" id="format" name="format" type="text" value="{{ form_data.get('format','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="revisions">Revisions requested</label>
              <input class="pb-input" id="revisions" name="revisions" type="number" min="0" step="1" value="{{ form_data.get('revisions','') }}">
            </div>
          </div>

        {% elif is_videographer %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="video_type">Video type</label>
              <select class="pb-select" id="video_type" name="video_type">
                <option value="">Choose…</option>
                <option {% if form_data.get('video_type')=='Music video' %}selected{% endif %}>Music video</option>
                <option {% if form_data.get('video_type')=='Live performance' %}selected{% endif %}>Live performance</option>
                <option {% if form_data.get('video_type')=='Promo video' %}selected{% endif %}>Promo video</option>
                <option {% if form_data.get('video_type')=='Behind the scenes' %}selected{% endif %}>Behind the scenes</option>
                <option {% if form_data.get('video_type')=='Event coverage' %}selected{% endif %}>Event coverage</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="duration">Video duration</label>
              <input class="pb-input" id="duration" name="duration" type="text" placeholder="e.g. 3-4 minutes" value="{{ form_data.get('duration','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="locations">Shoot locations</label>
              <input class="pb-input" id="locations" name="locations" type="text" value="{{ form_data.get('locations','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="deliverables_video">Deliverables</label>
              <select class="pb-select" id="deliverables_video" name="deliverables_video">
                <option value="">Choose…</option>
                <option {% if form_data.get('deliverables_video')=='Final video only' %}selected{% endif %}>Final video only</option>
                <option {% if form_data.get('deliverables_video')=='Video + raw footage' %}selected{% endif %}>Video + raw footage</option>
                <option {% if form_data.get('deliverables_video')=='Video + BTS content' %}selected{% endif %}>Video + BTS content</option>
              </select>
            </div>
          </div>

        {% elif is_photographer %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="photo_type">Photo shoot type</label>
              <select class="pb-select" id="photo_type" name="photo_type">
                <option value="">Choose…</option>
                <option {% if form_data.get('photo_type')=='Headshots' %}selected{% endif %}>Headshots</option>
                <option {% if form_data.get('photo_type')=='Portrait session' %}selected{% endif %}>Portrait session</option>
                <option {% if form_data.get('photo_type')=='Event photography' %}selected{% endif %}>Event photography</option>
                <option {% if form_data.get('photo_type')=='Product photos' %}selected{% endif %}>Product photos</option>
                <option {% if form_data.get('photo_type')=='Concert/performance' %}selected{% endif %}>Concert/performance</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="photos_needed">Number of photos needed</label>
              <input class="pb-input" id="photos_needed" name="photos_needed" type="number" min="1" step="1" value="{{ form_data.get('photos_needed','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="locations_photo">Shoot location</label>
              <input class="pb-input" id="locations_photo" name="locations_photo" type="text" value="{{ form_data.get('locations_photo','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="editing">Editing included?</label>
              <select class="pb-select" id="editing" name="editing">
                <option value="">Choose…</option>
                <option {% if form_data.get('editing')=='Yes' %}selected{% endif %}>Yes</option>
                <option {% if form_data.get('editing')=='No' %}selected{% endif %}>No</option>
              </select>
            </div>
          </div>

        {% elif is_dj %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="event_type_dj">Event type</label>
              <select class="pb-select" id="event_type_dj" name="event_type_dj">
                <option value="">Choose…</option>
                <option {% if form_data.get('event_type_dj')=='Club/venue' %}selected{% endif %}>Club/venue</option>
                <option {% if form_data.get('event_type_dj')=='Private party' %}selected{% endif %}>Private party</option>
                <option {% if form_data.get('event_type_dj')=='Wedding' %}selected{% endif %}>Wedding</option>
                <option {% if form_data.get('event_type_dj')=='Corporate event' %}selected{% endif %}>Corporate event</option>
                <option {% if form_data.get('event_type_dj')=='Festival' %}selected{% endif %}>Festival</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="equipment_provided">Equipment provided?</label>
              <select class="pb-select" id="equipment_provided" name="equipment_provided">
                <option value="">Choose…</option>
                <option {% if form_data.get('equipment_provided')=='Yes, venue provides' %}selected{% endif %}>Yes, venue provides</option>
                <option {% if form_data.get('equipment_provided')=='DJ brings own' %}selected{% endif %}>DJ brings own</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="genre_preference">Genre preference</label>
              <input class="pb-input" id="genre_preference" name="genre_preference" type="text" value="{{ form_data.get('genre_preference','') }}">
            </div>
          </div>

        {% elif is_artist %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="performance_type">Performance type</label>
              <select class="pb-select" id="performance_type" name="performance_type">
                <option value="">Choose…</option>
                <option {% if form_data.get('performance_type')=='Live concert' %}selected{% endif %}>Live concert</option>
                <option {% if form_data.get('performance_type')=='Festival' %}selected{% endif %}>Festival</option>
                <option {% if form_data.get('performance_type')=='Private event' %}selected{% endif %}>Private event</option>
                <option {% if form_data.get('performance_type')=='Corporate event' %}selected{% endif %}>Corporate event</option>
                <option {% if form_data.get('performance_type')=='Opening act' %}selected{% endif %}>Opening act</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="venue_type">Venue type</label>
              <input class="pb-input" id="venue_type" name="venue_type" type="text" placeholder="e.g. Outdoor, Indoor, Stadium" value="{{ form_data.get('venue_type','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="expected_audience">Expected audience size</label>
              <input class="pb-input" id="expected_audience" name="expected_audience" type="text" placeholder="e.g. 100-200 people" value="{{ form_data.get('expected_audience','') }}">
            </div>
          </div>

        {% elif is_event_planner %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="event_type_planner">Event type</label>
              <select class="pb-select" id="event_type_planner" name="event_type_planner">
                <option value="">Choose…</option>
                <option {% if form_data.get('event_type_planner')=='Wedding' %}selected{% endif %}>Wedding</option>
                <option {% if form_data.get('event_type_planner')=='Corporate' %}selected{% endif %}>Corporate</option>
                <option {% if form_data.get('event_type_planner')=='Concert/Show' %}selected{% endif %}>Concert/Show</option>
                <option {% if form_data.get('event_type_planner')=='Festival' %}selected{% endif %}>Festival</option>
                <option {% if form_data.get('event_type_planner')=='Birthday/Party' %}selected{% endif %}>Birthday/Party</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="guest_count">Expected guest count</label>
              <input class="pb-input" id="guest_count" name="guest_count" type="number" min="1" step="1" value="{{ form_data.get('guest_count','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="planning_scope">Planning scope</label>
              <select class="pb-select" id="planning_scope" name="planning_scope">
                <option value="">Choose…</option>
                <option {% if form_data.get('planning_scope')=='Full planning' %}selected{% endif %}>Full planning</option>
                <option {% if form_data.get('planning_scope')=='Day-of coordination' %}selected{% endif %}>Day-of coordination</option>
                <option {% if form_data.get('planning_scope')=='Partial planning' %}selected{% endif %}>Partial planning</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="venue_location">Venue/location</label>
              <input class="pb-input" id="venue_location" name="venue_location" type="text" value="{{ form_data.get('venue_location','') }}">
            </div>
          </div>

        {% elif is_live_sound %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="event_type_sound">Event type</label>
              <select class="pb-select" id="event_type_sound" name="event_type_sound">
                <option value="">Choose…</option>
                <option {% if form_data.get('event_type_sound')=='Concert' %}selected{% endif %}>Concert</option>
                <option {% if form_data.get('event_type_sound')=='Live performance' %}selected{% endif %}>Live performance</option>
                <option {% if form_data.get('event_type_sound')=='Corporate event' %}selected{% endif %}>Corporate event</option>
                <option {% if form_data.get('event_type_sound')=='Festival' %}selected{% endif %}>Festival</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="venue_size">Venue size</label>
              <input class="pb-input" id="venue_size" name="venue_size" type="text" placeholder="e.g. Small club, Large venue" value="{{ form_data.get('venue_size','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="equipment_needed">Equipment provided?</label>
              <select class="pb-select" id="equipment_needed" name="equipment_needed">
                <option value="">Choose…</option>
                <option {% if form_data.get('equipment_needed')=='Venue has equipment' %}selected{% endif %}>Venue has equipment</option>
                <option {% if form_data.get('equipment_needed')=='Engineer brings equipment' %}selected{% endif %}>Engineer brings equipment</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="band_count">Number of performers/bands</label>
              <input class="pb-input" id="band_count" name="band_count" type="number" min="1" step="1" value="{{ form_data.get('band_count','') }}">
            </div>
          </div>

        {% elif is_emcee %}
          <div class="pb-grid">
            <div class="pb-field">
              <label class="pb-label" for="event_type_emcee">Event type</label>
              <select class="pb-select" id="event_type_emcee" name="event_type_emcee">
                <option value="">Choose…</option>
                <option {% if form_data.get('event_type_emcee')=='Concert' %}selected{% endif %}>Concert</option>
                <option {% if form_data.get('event_type_emcee')=='Corporate event' %}selected{% endif %}>Corporate event</option>
                <option {% if form_data.get('event_type_emcee')=='Festival' %}selected{% endif %}>Festival</option>
                <option {% if form_data.get('event_type_emcee')=='Award show' %}selected{% endif %}>Award show</option>
              </select>
            </div>
            <div class="pb-field">
              <label class="pb-label" for="style_emcee">Style/preference</label>
              <input class="pb-input" id="style_emcee" name="style_emcee" type="text" placeholder="e.g. Energetic, Professional, Humorous" value="{{ form_data.get('style_emcee','') }}">
            </div>
            <div class="pb-field">
              <label class="pb-label" for="announcements">Special announcements needed?</label>
              <select class="pb-select" id="announcements" name="announcements">
                <option value="">Choose…</option>
                <option {% if form_data.get('announcements')=='Yes' %}selected{% endif %}>Yes</option>
                <option {% if form_data.get('announcements')=='No' %}selected{% endif %}>No</option>
              </select>
            </div>
          </div>

        {% else %}
          <div class="pb-hint">This provider uses the general request form — add any details below.</div>
        {% endif %}
      </div>

      <div class="pb-section">
        <div class="pb-field">
          <label class="pb-label" for="message">Message to provider</label>
          <textarea class="pb-textarea" id="message" name="message" placeholder="Describe what you need, references, links, etc...">{{ form_data.get('message','') }}</textarea>
        </div>
        <div class="pb-hint">Any extra fields above will be included in the booking request automatically.</div>
      </div>

      <div class="pb-footer">
        <a class="pb-btn" href="{{ url_for('provider_portfolio_public', username=provider.username) }}">← Back</a>
        <button type="submit" class="pb-btn pb-btn-primary">Send booking request</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
