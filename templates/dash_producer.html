{% extends "base.html" %}
{% block title %}Producer Dashboard Â· BeatFund{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  .bf-producer { max-width: 1200px; margin: 0 auto; padding: 16px; }
  .bf-hero { display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom: 20px; }
  .bf-hero-left { display:flex; gap:12px; align-items:center; min-width: 260px; }
  .bf-avatar { width: 56px; height: 56px; border-radius: 16px; object-fit: cover; border: 1px solid rgba(255,255,255,.12); }
  .bf-title { margin:0; font-size: 1.35rem; line-height: 1.2; }
  .bf-sub { margin:4px 0 0; opacity:.8; font-size: .95rem; }
  .bf-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

  .bf-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-top: 14px; }
  .bf-card { border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); border-radius: 18px; padding: 16px; }
  .bf-card h3 { margin:0 0 12px; font-size: 1.1rem; font-weight: 700; }
  .bf-kpis { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .bf-kpi { padding: 14px; border-radius: 16px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); }
  .bf-kpi .label { opacity:.75; font-size: .9rem; margin-bottom: 6px; }
  .bf-kpi .value { font-size: 1.5rem; font-weight: 800; line-height: 1.2; }
  .bf-kpi .hint { opacity:.7; font-size: .85rem; margin-top: 6px; }

  .bf-btn {
    display:inline-flex; align-items:center; justify-content:center;
    padding: 12px 16px; border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.08);
    color: inherit;
    text-decoration:none;
    font-weight: 600;
    min-height: 44px;
    transition: all 0.2s ease;
  }
  .bf-btn:hover { background: rgba(255,255,255,.12); transform: translateY(-1px); }
  .bf-btn.primary { background: linear-gradient(135deg, rgba(124,58,237,.4), rgba(236,72,153,.3)); border-color: rgba(124,58,237,.5); }
  .bf-btn.primary:hover { background: linear-gradient(135deg, rgba(124,58,237,.5), rgba(236,72,153,.4)); }
  .bf-btn.block { width: 100%; }

  .bf-list { display:flex; flex-direction:column; gap:10px; }
  .bf-row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.2); }
  .bf-row .left { min-width: 0; flex: 1; }
  .bf-row .title { font-weight: 700; font-size: 1rem; }
  .bf-row .meta { opacity:.75; font-size:.9rem; margin-top: 4px; }
  .bf-chip {
    display:inline-flex; align-items:center;
    padding: 6px 12px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size: .85rem; opacity:.9;
  }

  .bf-upload-cta {
    text-align: center;
    padding: 24px;
    border-radius: 18px;
    background: linear-gradient(135deg, rgba(124,58,237,.15), rgba(236,72,153,.1));
    border: 1px solid rgba(124,58,237,.3);
    margin-bottom: 20px;
  }
  .bf-upload-cta h2 { margin: 0 0 8px; font-size: 1.3rem; }
  .bf-upload-cta p { margin: 0 0 16px; opacity: .8; font-size: .95rem; }

  .span-12 { grid-column: span 12; }
  .span-8 { grid-column: span 12; }
  .span-4 { grid-column: span 12; }
  .span-6 { grid-column: span 12; }

  @media (min-width: 900px){
    .span-8 { grid-column: span 8; }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
  }

  /* Mobile Responsive Styles */
  @media (max-width: 600px) {
    .bf-producer {
      padding: 12px;
    }
    
    .bf-hero {
      flex-direction: column;
      align-items: stretch;
      gap: 12px;
    }
    
    .bf-hero-left {
      min-width: 0;
      width: 100%;
    }
    
    .bf-title {
      font-size: 1.2rem;
    }
    
    .bf-sub {
      font-size: 0.9rem;
    }
    
    .bf-actions {
      width: 100%;
      flex-direction: column;
    }
    
    .bf-actions .bf-btn {
      width: 100%;
      min-height: 48px;
      font-size: 14px;
    }
    
    .bf-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .bf-card {
      padding: 12px;
    }
    
    .bf-card h3 {
      font-size: 1rem;
    }
    
    .bf-kpis {
      grid-template-columns: 1fr;
    }
    
    .bf-kpi {
      padding: 12px;
    }
    
    .bf-kpi .value {
      font-size: 1.3rem;
    }
    
    .bf-upload-cta {
      padding: 16px;
    }
    
    .bf-upload-cta h2 {
      font-size: 1.1rem;
    }
    
    .bf-upload-cta p {
      font-size: 0.9rem;
    }
    
    .bf-row {
      flex-direction: column;
      align-items: stretch;
      padding: 10px;
    }
    
    .bf-row .title {
      font-size: 0.95rem;
    }
    
    .bf-chip {
      padding: 6px 10px;
      font-size: 0.8rem;
      min-height: 32px;
    }
    
    /* Modal improvements */
    .modal-overlay {
      padding: 12px;
    }
    
    .modal-content {
      border-radius: 16px;
      max-height: 90vh;
    }
    
    .modal-header {
      padding: 16px;
    }
    
    .modal-header h2 {
      font-size: 1.1rem;
    }
    
    .modal-body {
      padding: 16px;
    }
    
    /* User list improvements */
    .user-list {
      gap: 8px;
    }
    
    .user-item {
      padding: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
    }
    
    .user-name {
      font-size: 0.9rem;
    }
  }

  /* Modal styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,.7);
    backdrop-filter: blur(4px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .modal-overlay.active {
    display: flex;
  }
  
  .modal-content {
    background: rgba(15,23,42,.95);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 20px;
    max-width: 600px;
    width: 100%;
    max-height: 80vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,.6);
  }
  
  .modal-header {
    padding: 20px;
    border-bottom: 1px solid rgba(255,255,255,.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .modal-header h2 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 700;
  }
  
  .modal-close {
    background: none;
    border: none;
    color: rgba(255,255,255,.7);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s ease;
  }
  
  .modal-close:hover {
    background: rgba(255,255,255,.1);
    color: rgba(255,255,255,1);
  }
  
  .modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
  }
  
  .user-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.08);
    background: rgba(255,255,255,.03);
    transition: all 0.2s ease;
  }
  
  .user-item:hover {
    background: rgba(255,255,255,.06);
    border-color: rgba(255,255,255,.12);
  }
  
  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    object-fit: cover;
    border: 1px solid rgba(255,255,255,.12);
  }
  
  .user-info {
    flex: 1;
    min-width: 0;
  }
  
  .user-name {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 4px;
  }
  
  .user-username {
    opacity: 0.7;
    font-size: 0.9rem;
  }
  
  .user-role {
    opacity: 0.6;
    font-size: 0.85rem;
    margin-top: 2px;
  }
  
  .user-link {
    color: inherit;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0;
  }
  
  .user-link:hover {
    color: inherit;
  }
  
  .loading-state, .empty-state {
    text-align: center;
    padding: 40px 20px;
    opacity: 0.7;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 32px;
    height: 32px;
    border: 3px solid rgba(255,255,255,.1);
    border-top-color: rgba(124,58,237,1);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Booking request status badges */
  .status-pending {
    background: rgba(251,191,36,.2) !important;
    border-color: rgba(251,191,36,.4) !important;
    color: #fbbf24 !important;
  }

  .status-accepted {
    background: rgba(34,197,94,.2) !important;
    border-color: rgba(34,197,94,.4) !important;
    color: #22c55e !important;
  }

  .status-declined, .status-cancelled {
    background: rgba(239,68,68,.2) !important;
    border-color: rgba(239,68,68,.4) !important;
    color: #ef4444 !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="bf-producer">

  <div class="bf-hero">
    <div class="bf-hero-left">
      <img class="bf-avatar" src="{{ current_user.avatar_url }}" alt="avatar">
      <div>
        <h1 class="bf-title">Producer Dashboard</h1>
        <p class="bf-sub">@{{ current_user.username }} Â· Create & sell beats</p>
        <div style="display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap;">
          <button type="button" class="bf-chip" style="background: rgba(124,58,237,.15); border-color: rgba(124,58,237,.3); cursor: pointer; border: 1px solid rgba(124,58,237,.3); transition: all 0.2s ease;" onclick="showFollowers()" onmouseover="this.style.background='rgba(124,58,237,.25)'; this.style.borderColor='rgba(124,58,237,.5)'" onmouseout="this.style.background='rgba(124,58,237,.15)'; this.style.borderColor='rgba(124,58,237,.3)'">
            <span style="display: inline-block; width: 8px; height: 8px; background: rgba(124,58,237,1); border-radius: 50%; margin-right: 6px;"></span>
            Followers: <strong>{{ followers_count }}</strong>
          </button>
          <button type="button" class="bf-chip" style="background: rgba(236,72,153,.15); border-color: rgba(236,72,153,.3); cursor: pointer; border: 1px solid rgba(236,72,153,.3); transition: all 0.2s ease;" onclick="showFollowing()" onmouseover="this.style.background='rgba(236,72,153,.25)'; this.style.borderColor='rgba(236,72,153,.5)'" onmouseout="this.style.background='rgba(236,72,153,.15)'; this.style.borderColor='rgba(236,72,153,.3)'">
            Following: <strong>{{ following_count }}</strong>
          </button>
        </div>
      </div>
    </div>

    <div class="bf-actions">
      <a class="bf-btn primary" href="{{ url_for('producer_market_upload') }}">Upload Beat</a>
      <a class="bf-btn" href="{{ url_for('wallet_home') }}">Wallet</a>
      <a class="bf-btn" href="{{ url_for('market_index') }}">Marketplace</a>
      <a class="bf-btn" href="{{ url_for('producer_catalog_detail', username=current_user.username) }}">Public Profile</a>
    </div>
  </div>

  <!-- Upload CTA -->
  <div class="bf-upload-cta">
    <h2>Ready to upload a new beat?</h2>
    <p>Share your music with artists and start earning. Upload cover art, preview audio, and stems.</p>
    <a class="bf-btn primary" href="{{ url_for('producer_market_upload') }}" style="font-size: 1rem; padding: 14px 28px;">
      Upload New Beat â†’
    </a>
  </div>

  {% include '_role_switcher.html' %}

  <div class="bf-grid">

    <!-- Key Metrics -->
    <div class="bf-card span-12">
      <h3>Your Business at a Glance</h3>
      <div class="bf-kpis">
        <div class="bf-kpi">
          <div class="label">Active Beats</div>
          <div class="value">{{ total_beats }}</div>
          <div class="hint">Listed in marketplace</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Total Sales</div>
          <div class="value">{{ sales_count }}</div>
          <div class="hint">Beats sold</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Gross Revenue</div>
          <div class="value">${{ '%.2f'|format(revenue) }}</div>
          <div class="hint">Total earnings</div>
        </div>
        {% if wallet_balance is defined %}
        <div class="bf-kpi">
          <div class="label">Wallet Balance</div>
          <div class="value">${{ '%.2f'|format(wallet_balance) }}</div>
          <div class="hint">Available to withdraw</div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="bf-card span-4">
      <h3>Quick Actions</h3>
      <div class="bf-list">
        <a class="bf-btn block primary" href="{{ url_for('producer_market_upload') }}">
          Upload New Beat
        </a>
        <a class="bf-btn block" href="{{ url_for('producer_market_mine') }}">
          Manage Listings
        </a>
        <a class="bf-btn block" href="{{ url_for('wallet_home', tab='transactions') }}">
          View Sales & Transactions
        </a>
        <a class="bf-btn block" href="{{ url_for('producer_beats') }}">
          Beat Catalog
        </a>
        <a class="bf-btn block" href="{{ url_for('producer_catalog_detail', username=current_user.username) }}">
          Public Profile
        </a>
        <a class="bf-btn block" href="{{ url_for('wallet_home') }}">
          Wallet & Payments
        </a>
        <a class="bf-btn block" href="{{ url_for('bookme_requests') }}">
          Booking Requests
          {% if incoming_requests_count > 0 %}
            <span style="margin-left: 8px; background: rgba(251,191,36,.2); color: #fbbf24; padding: 2px 8px; border-radius: 999px; font-size: .8rem; font-weight: 700;">{{ incoming_requests_count }}</span>
          {% endif %}
        </a>
        <a class="bf-btn block" href="{{ url_for('vaults_index') }}" style="background: linear-gradient(135deg, rgba(6,182,212,.3), rgba(34,197,94,.2)); border-color: rgba(6,182,212,.5);">
          ðŸ’° Project Vaults
        </a>
      </div>
    </div>

    <!-- Booking Requests -->
    {% if incoming_requests_count > 0 or outgoing_requests|length > 0 %}
    <div class="bf-card span-8">
      <h3>
        Booking Requests
        {% if incoming_requests_count > 0 %}
          <span style="margin-left: 8px; background: rgba(251,191,36,.2); color: #fbbf24; padding: 2px 8px; border-radius: 999px; font-size: .8rem; font-weight: 700;">{{ incoming_requests_count }} pending</span>
        {% endif %}
      </h3>
      
      {% if incoming_requests|length > 0 %}
        <div class="bf-list" style="margin-bottom: 16px;">
          <div style="opacity: .8; font-size: .9rem; margin-bottom: 12px; font-weight: 600;">Incoming Requests</div>
          {% for req in incoming_requests %}
            <div class="bf-row">
              <div class="left">
                <div class="title">
                  @{{ req.client.username }}
                  <span class="bf-chip" style="background: rgba(251,191,36,.2); border-color: rgba(251,191,36,.4); color: #fbbf24;">Pending</span>
                </div>
                <div class="meta">
                  <strong>Time:</strong> {{ req.preferred_time }}<br>
                  {% if req.message %}
                    <strong>Message:</strong> {{ req.message[:60] }}{% if req.message|length > 60 %}...{% endif %}
                  {% endif %}
                </div>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <a href="{{ url_for('bookme_request_accept_confirm', req_id=req.id) }}" class="bf-btn" style="font-size: .9rem; padding: 8px 12px;">Accept</a>
                <form method="post" action="{{ url_for('bookme_request_status', req_id=req.id) }}" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="action" value="decline">
                  <button type="submit" class="bf-btn" style="font-size: .9rem; padding: 8px 12px; background: rgba(239,68,68,.2); border-color: rgba(239,68,68,.4); color: #ef4444;">Decline</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
        {% if incoming_requests_count > incoming_requests|length %}
          <div style="margin-top: 12px;">
            <a class="bf-btn block" href="{{ url_for('bookme_requests') }}">View All Requests ({{ incoming_requests_count }} total)</a>
          </div>
        {% else %}
          <div style="margin-top: 12px;">
            <a class="bf-btn block" href="{{ url_for('bookme_requests') }}">Manage All Requests</a>
          </div>
        {% endif %}
      {% elif outgoing_requests|length > 0 %}
        <div class="bf-list">
          <div style="opacity: .8; font-size: .9rem; margin-bottom: 12px; font-weight: 600;">Your Requests</div>
          {% for req in outgoing_requests[:3] %}
            <div class="bf-row">
              <div class="left">
                <div class="title">
                  @{{ req.provider.username }}
                  <span class="bf-chip 
                    {% if req.status == BookingStatus.pending %}status-pending
                    {% elif req.status == BookingStatus.accepted %}status-accepted
                    {% elif req.status == BookingStatus.declined %}status-declined
                    {% endif %}">
                    {{ req.status.value|title }}
                  </span>
                </div>
                <div class="meta">{{ req.preferred_time }}</div>
              </div>
              <a class="bf-btn" href="{{ url_for('bookme_requests') }}" style="font-size: .9rem; padding: 8px 12px;">View</a>
            </div>
          {% endfor %}
          <div style="margin-top: 12px;">
            <a class="bf-btn block" href="{{ url_for('bookme_requests') }}">View All Your Requests</a>
          </div>
        </div>
      {% else %}
        <div style="padding: 20px; text-align: center; opacity: .7;">
          No booking requests yet. <a href="{{ url_for('bookme_search') }}" style="color: #4de3ff;">Browse BookMe</a> to receive requests.
        </div>
      {% endif %}
    </div>
    {% else %}
    <!-- Recent Activity / Info -->
    <div class="bf-card span-8">
      <h3>Getting Started</h3>
      <div class="bf-list">
        <div class="bf-row">
          <div class="left">
            <div class="title">Upload Your First Beat</div>
            <div class="meta">Create beats, set prices, and start selling to artists worldwide</div>
          </div>
          <a class="bf-btn" href="{{ url_for('producer_market_upload') }}">Upload</a>
        </div>
        <div class="bf-row">
          <div class="left">
            <div class="title">Manage Your Catalog</div>
            <div class="meta">Edit prices, update covers, and organize your beat library</div>
          </div>
          <a class="bf-btn" href="{{ url_for('producer_market_mine') }}">Manage</a>
        </div>
        <div class="bf-row">
          <div class="left">
            <div class="title">Track Your Sales</div>
            <div class="meta">Monitor revenue, see who bought your beats, and manage earnings</div>
          </div>
          <a class="bf-btn" href="{{ url_for('wallet_home') }}">View Wallet</a>
        </div>
        <div class="bf-row">
          <div class="left">
            <div class="title">Build Your Profile</div>
            <div class="meta">Showcase your work and let artists discover your beats</div>
          </div>
          <a class="bf-btn" href="{{ url_for('producer_catalog_detail', username=current_user.username) }}">View Profile</a>
        </div>
        <div class="bf-row">
          <div class="left">
            <div class="title">Enable BookMe Booking</div>
            <div class="meta">Set up your BookMe profile to receive booking requests from artists</div>
          </div>
          <a class="bf-btn" href="{{ url_for('bookme_profile') }}">Setup BookMe</a>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Marketplace Stats -->
    <div class="bf-card span-6">
      <h3>Your Marketplace Presence</h3>
      <div style="padding: 12px 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="opacity: .8;">Active Listings</span>
          <span class="bf-chip">{{ total_beats }} beats</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="opacity: .8;">Total Sales</span>
          <span class="bf-chip">{{ sales_count }} orders</span>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="opacity: .8;">Total Revenue</span>
          <span class="bf-chip" style="background: rgba(34,197,94,.2); border-color: rgba(34,197,94,.4);">${{ '%.2f'|format(revenue) }}</span>
        </div>
      </div>
      <div style="margin-top: 16px;">
        <a class="bf-btn block" href="{{ url_for('market_index') }}">Browse Marketplace</a>
      </div>
    </div>

    <!-- Sales & Earnings -->
    <div class="bf-card span-6">
      <h3>Sales & Earnings</h3>
      <div style="padding: 12px 0;">
        <div style="margin-bottom: 16px;">
          <div style="font-size: 2rem; font-weight: 800; line-height: 1.2; margin-bottom: 4px;">
            ${{ '%.2f'|format(revenue) }}
          </div>
          <div style="opacity: .7; font-size: .9rem;">Total gross revenue</div>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <span class="bf-chip">{{ sales_count }} sales</span>
          {% if total_beats > 0 %}
          <span class="bf-chip">${{ '%.2f'|format(revenue / total_beats if total_beats > 0 else 0) }} avg/beat</span>
          {% endif %}
        </div>
      </div>
      <div style="margin-top: 16px;">
        <a class="bf-btn block" href="{{ url_for('wallet_home') }}">View Wallet & Transactions</a>
      </div>
    </div>

  </div>
</div>

<!-- Followers/Following Modal -->
<div class="modal-overlay" id="socialModal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h2 id="modalTitle">Followers</h2>
      <button class="modal-close" onclick="closeModal()" aria-label="Close">Ã—</button>
    </div>
    <div class="modal-body" id="modalBody">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p style="margin-top: 12px;">Loading...</p>
  </div>
  </div>
  </div>
</div>

<script>
  let currentModalType = null;

  function showFollowers() {
    currentModalType = 'followers';
    document.getElementById('modalTitle').textContent = 'Followers';
    document.getElementById('socialModal').classList.add('active');
    loadSocialList('followers');
  }

  function showFollowing() {
    currentModalType = 'following';
    document.getElementById('modalTitle').textContent = 'Following';
    document.getElementById('socialModal').classList.add('active');
    loadSocialList('following');
  }

  function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('socialModal').classList.remove('active');
    currentModalType = null;
  }

  async function loadSocialList(type) {
    const modalBody = document.getElementById('modalBody');
    modalBody.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p style="margin-top: 12px;">Loading...</p></div>';

    try {
      const followersUrl = '{{ url_for("api_followers", user_id=current_user.id) }}';
      const followingUrl = '{{ url_for("api_following", user_id=current_user.id) }}';
      const url = type === 'followers' ? followersUrl : followingUrl;
      
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error('Failed to load');
      }

      const data = await response.json();
      const users = type === 'followers' ? data.followers : data.following;

      if (users.length === 0) {
        modalBody.innerHTML = '<div class="empty-state"><p>No ' + type + ' yet.</p></div>';
        return;
      }

      let html = '<div class="user-list">';
      for (let i = 0; i < users.length; i++) {
        const user = users[i];
        const profileUrl = '/u/' + user.username;
        let roleText = '';
        if (user.role) {
          roleText = user.role.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
        }
        html += '<div class="user-item">';
        html += '<a href="' + profileUrl + '" class="user-link">';
        html += '<img src="' + user.avatar_url + '" alt="' + escapeHtml(user.username) + '" class="user-avatar">';
        html += '<div class="user-info">';
        html += '<div class="user-name">' + escapeHtml(user.display_name) + '</div>';
        html += '<div class="user-username">@' + escapeHtml(user.username) + '</div>';
        if (user.role) {
          html += '<div class="user-role">' + escapeHtml(roleText) + '</div>';
        }
        html += '</div>';
        html += '</a>';
        html += '</div>';
      }
      html += '</div>';
      modalBody.innerHTML = html;

    } catch (error) {
      modalBody.innerHTML = '<div class="empty-state"><p>Error loading ' + type + '. Please try again.</p></div>';
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Close modal on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && document.getElementById('socialModal').classList.contains('active')) {
      closeModal();
    }
  });
</script>
{% endblock %}
