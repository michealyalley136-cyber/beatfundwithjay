{% extends "base.html" %}
{% block title %}BookMe Directory · BeatFund{% endblock %}

{% block content %}
<div class="page bookme-directory-page">
  <header class="page-header">
    <h1>BookMe Directory</h1>
    <p class="text-muted">
      Browse service providers – dancers, DJs, videographers, studios, designers, and more.
    </p>
  </header>

  <div class="bookme-layout">
    <!-- Filters column -->
    <aside class="filters-panel">
      <h2>Filters</h2>

      <form method="get" action="{{ url_for('bookme_search') }}" class="filters-form">
        <!-- ROLE -->
        <div class="form-group">
          <label for="role">Role</label>
          {% set provider_roles = BOOKME_PROVIDER_ROLES if BOOKME_PROVIDER_ROLES is defined else [] %}
          <select id="role" name="role">
            <option value="">Any role</option>
            {% for r in RoleEnum %}
              {% if r.value in provider_roles %}
                <option value="{{ r.value }}"
                        {% if current_filters.role == r.value %}selected{% endif %}>
                  {{ r.value.replace("_", " ").title() }}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <!-- NAME / SERVICE -->
        <div class="form-group">
          <label for="q">Name / Service</label>
          <input
            id="q"
            type="text"
            name="q"
            value="{{ current_filters.q }}"
            placeholder="Search display name, service, city..."
          >
        </div>

        <!-- CITY -->
        <div class="form-group">
          <label for="city">City</label>
          <input
            id="city"
            type="text"
            name="city"
            value="{{ current_filters.city }}"
          >
        </div>

        <!-- STATE -->
        <div class="form-group">
          <label for="state">State</label>
          <input
            id="state"
            type="text"
            name="state"
            value="{{ current_filters.state }}"
          >
        </div>

        <!-- ZIP -->
        <div class="form-group">
          <label for="zip">ZIP</label>
          <input
            id="zip"
            type="text"
            name="zip"
            value="{{ current_filters.zip }}"
          >
        </div>

        <button type="submit" class="btn btn-primary w-100">
          Apply filters
        </button>

        <a href="{{ url_for('bookme_search') }}" class="btn btn-secondary w-100 mt-2">
          Clear filters
        </a>
      </form>
    </aside>

    <!-- Results + Map column -->
    <section class="results-panel">
      <!-- Map -->
      <div class="map-wrapper">
        <div id="bookme-map"></div>
      </div>

      <!-- Providers list -->
      <div class="providers-header">
        <h2>Providers ({{ profiles|length }})</h2>
      </div>

      {% if profiles %}
        <div class="providers-list">
          {% for p in profiles %}
            <article class="provider-card">
              <div class="provider-main">
                <div class="provider-avatar">
                  <div class="avatar-circle">
                    {{ (p.display_name or p.user.username)[0:1] | upper }}
                  </div>
                </div>

                <div class="provider-info">
                  <h3 class="provider-name">
                    {{ p.display_name or p.user.username }}
                  </h3>

                  <div class="provider-role">
                    {{ p.user.role.value.replace("_", " ").title() }}
                  </div>

                  {% if p.service_types %}
                    <div class="provider-services">
                      {{ p.service_types }}
                    </div>
                  {% endif %}

                  {% if p.rate_notes %}
                    <div class="provider-rates text-muted">
                      {{ p.rate_notes }}
                    </div>
                  {% endif %}

                  <div class="provider-location text-muted">
                    {% if p.city or p.state %}
                      {{ p.city }}, {{ p.state }}
                    {% elif p.zip %}
                      ZIP {{ p.zip }}
                    {% else %}
                      Location not set
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="provider-actions">
                <a
                  href="{{ url_for('provider_portfolio_public', username=p.user.username) }}"
                  class="btn btn-secondary btn-sm"
                >
                  View profile
                </a>

                {% if current_user.is_authenticated and current_user.id != p.user.id %}
                  <!-- Use same booking flow as artist public page -->
                  <a
                    href="{{ url_for('book_artist', username=p.user.username) }}"
                    class="btn btn-primary btn-sm"
                  >
                    Request booking
                  </a>
                {% else %}
                  <span class="btn btn-disabled btn-sm">
                    This is you
                  </span>
                {% endif %}
              </div>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <p class="no-results">
          No providers match these filters yet. Try adjusting your search.
        </p>
      {% endif %}
    </section>
  </div>
</div>

<!-- Leaflet CSS/JS from local static files -->
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='leaflet/leaflet.css') }}"
>
<script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>

<style>
  .bookme-layout {
    display: grid;
    grid-template-columns: 280px minmax(0, 1fr);
    gap: 2rem;
    margin-top: 1.5rem;
  }
  .filters-panel {
    background: #050b1a;
    border-radius: 12px;
    padding: 1.25rem;
  }
  .filters-panel h2 {
    margin-top: 0;
    margin-bottom: 1rem;
  }
  .filters-form .form-group {
    margin-bottom: 0.75rem;
  }
  .filters-form label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
    opacity: 0.85;
  }
  .filters-form input,
  .filters-form select {
    width: 100%;
    padding: 0.4rem 0.5rem;
    border-radius: 6px;
    border: 1px solid #1f2937;
    background: #020617;
    color: #e5e7eb;
    font-size: 0.9rem;
  }
  .map-wrapper {
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
  }
  #bookme-map {
    width: 100%;
    height: 260px;
    position: relative;
    background: radial-gradient(circle at 10% 20%, #1e293b 0, #020617 60%);
  }
  /* placeholder text until we know Leaflet initialised */
  #bookme-map::before {
    content: "Map loading…";
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: #9ca3af;
    opacity: 0.8;
    pointer-events: none;
  }
  #bookme-map.has-map::before {
    content: "";
  }

  .providers-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 0.75rem;
  }
  .provider-card {
    background: #050b1a;
    border-radius: 12px;
    padding: 0.9rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }
  .provider-main {
    display: flex;
    align-items: center;
    gap: 0.9rem;
  }
  .avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    background: linear-gradient(135deg, #6366f1, #22c55e);
  }
  .provider-info h3 {
    margin: 0;
    font-size: 1rem;
  }
  .provider-role {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.8;
    margin-top: 0.15rem;
  }
  .provider-services {
    margin-top: 0.25rem;
    font-size: 0.85rem;
  }
  .provider-rates,
  .provider-location {
    margin-top: 0.2rem;
    font-size: 0.8rem;
  }
  .provider-actions {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 140px;
    align-items: flex-end;
  }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
    font-size: 0.8rem;
    border: none;
    cursor: pointer;
    text-decoration: none;
  }
  .btn-primary {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
  }
  .btn-secondary {
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
    border: 1px solid rgba(148, 163, 184, 0.4);
  }
  .btn-disabled {
    background: rgba(51, 65, 85, 0.6);
    color: rgba(148, 163, 184, 0.9);
    cursor: default;
  }
  .btn-sm {
    padding: 0.3rem 0.8rem;
    font-size: 0.78rem;
  }
  .providers-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
  }
  .no-results {
    margin-top: 1rem;
    font-size: 0.9rem;
    opacity: 0.8;
  }

  @media (max-width: 900px) {
    .bookme-layout {
      grid-template-columns: 1fr;
    }
    .provider-card {
      flex-direction: column;
      align-items: flex-start;
    }
    .provider-actions {
      flex-direction: row;
      align-items: center;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var mapEl = document.getElementById("bookme-map");
    if (!mapEl) return;

    // If Leaflet didn't load for some reason, just keep the "Map loading…" placeholder.
    if (typeof L === "undefined") {
      console.error("Leaflet library not found. Check static path for leaflet.js.");
      return;
    }

    var defaultCenter = [39.5, -98.35]; // rough center of US
    var map = L.map("bookme-map").setView(defaultCenter, 4);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Mark map as initialised (hide 'Map loading…' text)
    mapEl.classList.add("has-map");

    var markers = [];

    function loadPins() {
      var params = new URLSearchParams(window.location.search);
      fetch("{{ url_for('bookme_data') }}?" + params.toString())
        .then(function (r) { return r.json(); })
        .then(function (rows) {
          markers.forEach(function (m) { map.removeLayer(m); });
          markers = [];

          if (!rows.length) {
            map.setView(defaultCenter, 3);
            return;
          }

          var bounds = [];

          rows.forEach(function (row) {
            if (row.lat == null || row.lng == null) return;

            var marker = L.marker([row.lat, row.lng]).addTo(map);
            var popupHtml =
              "<strong>" + (row.display_name || row.username || "Provider") + "</strong><br>" +
              (row.service_types || "") + "<br>" +
              (row.city || "") + (row.state ? (", " + row.state) : "");

            marker.bindPopup(popupHtml);
            markers.push(marker);
            bounds.push([row.lat, row.lng]);
          });

          if (bounds.length === 1) {
            map.setView(bounds[0], 11);
          } else if (bounds.length > 1) {
            map.fitBounds(bounds, { padding: [20, 20] });
          } else {
            map.setView(defaultCenter, 3);
          }
        })
        .catch(function (err) {
          console.error("Error loading BookMe map data:", err);
        });
    }

    loadPins();
  });
</script>
{% endblock %}
