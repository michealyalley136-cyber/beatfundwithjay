{% extends "base.html" %}
{% block title %}BookMe · Creative Services Directory{% endblock %}

{% block extra_head %}
  <!-- Leaflet map CSS (for the pins) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    .bm-page-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .bm-page-sub {
      font-size: 13px;
      color: #9aa4c2;
      margin-bottom: 18px;
    }

    .bm-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 16px;
      align-items: flex-start;
    }
    @media (max-width: 960px) {
      .bm-layout {
        grid-template-columns: 1fr;
      }
    }

    .bm-card {
      background: linear-gradient(135deg, #0b1220, #020617);
      border-radius: 16px;
      border: 1px solid #20263b;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.9);
      padding: 16px 18px;
    }

    /* Map card */
    #bm-map {
      width: 100%;
      height: 360px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #111827;
    }
    @media (max-width: 600px) {
      #bm-map {
        height: 260px;
      }
    }

    .bm-map-header {
      font-size: 13px;
      margin-bottom: 8px;
      color: #c7d2fe;
    }
    .bm-map-sub {
      font-size: 12px;
      color: #9aa4c2;
      margin-bottom: 10px;
    }

    /* Filters + list */
    .bm-card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .bm-card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .bm-card-sub {
      font-size: 12px;
      color: #9aa4c2;
    }

    .bm-filters-toggle-pill {
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid #1f2937;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: default;
      white-space: nowrap;
    }

    .bm-filter-form {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    @media (max-width: 720px) {
      .bm-filter-form {
        grid-template-columns: 1fr;
      }
    }

    .bm-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #8f9bc6;
      margin-bottom: 2px;
    }
    .bm-input,
    .bm-select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #303a5c;
      background: rgba(12, 16, 36, 0.95);
      color: #e3e9ff;
      padding: 7px 10px;
      font-size: 13px;
    }
    .bm-input::placeholder {
      color: #6f7aa4;
    }

    .bm-filter-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .bm-btn-primary,
    .bm-btn-ghost {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-decoration: none;
    }
    .bm-btn-primary {
      background: linear-gradient(135deg, #33b5ff, #447aff);
      color: #fff;
    }
    .bm-btn-primary:hover {
      background: linear-gradient(135deg, #45c4ff, #5688ff);
    }
    .bm-btn-ghost {
      background: transparent;
      color: #c1ccff;
      border: 1px solid #3b476b;
    }
    .bm-btn-ghost:hover {
      background: rgba(34, 43, 75, 0.9);
    }

    /* Provider list */
    .bm-list {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }

    .bm-provider-card {
      border-radius: 14px;
      border: 1px solid #111827;
      background: rgba(4, 7, 20, 0.98);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) auto;
      gap: 8px;
      align-items: center;
    }
    @media (max-width: 640px) {
      .bm-provider-card {
        grid-template-columns: 1fr;
        align-items: flex-start;
      }
    }

    .bm-provider-title {
      font-size: 14px;
      font-weight: 500;
    }
    .bm-provider-meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }
    .bm-chip-role {
      border-radius: 999px;
      border: 1px solid rgba(96, 165, 250, 0.8);
      padding: 2px 8px;
      font-size: 11px;
      color: #bfdbfe;
    }
    .bm-chip-location {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 2px 8px;
      font-size: 11px;
      color: #e5e7eb;
    }
    .bm-provider-services {
      font-size: 12px;
      color: #9aa4c2;
      margin-top: 4px;
    }
    .bm-provider-rate {
      font-size: 12px;
      color: #c4d0ff;
      margin-top: 2px;
    }

    .bm-provider-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      font-size: 11px;
      color: #9aa4c2;
    }
    .bm-provider-actions .bm-btn-primary {
      padding-inline: 16px;
    }
  </style>
{% endblock %}

{% block content %}
  <h1 class="bm-page-title">Book creative services (BookMe)</h1>
  <p class="bm-page-sub">
    Find studios, producers, videographers and more. Use the map and filters to discover providers,
    then send a booking request.
  </p>

  <div class="bm-layout">
    <!-- LEFT: Map -->
    <div class="bm-card">
      <div class="bm-map-header">Where providers are located</div>
      <div class="bm-map-sub">
        Pins represent BookMe profiles with a city/state and optional coordinates.
      </div>
      <div id="bm-map"></div>
      <p class="bm-map-sub" style="margin-top:8px;">
        Tip: zoom and drag to explore other cities. Click a pin to see who’s there.
      </p>
    </div>

    <!-- RIGHT: Filters + list -->
    <div class="bm-card">
      <div class="bm-card-header-row">
        <div>
          <div class="bm-card-title">Service Providers</div>
          <div class="bm-card-sub">
            If you offer studio or creative services, create a BookMe profile to appear here.
          </div>
        </div>
        <div class="bm-filters-toggle-pill">
          Filters
        </div>
      </div>

      <!-- Filters -->
      <form class="bm-filter-form" method="GET" action="{{ url_for('bookme_search') }}">
        <div>
          <div class="bm-label">Provider type</div>
          <select name="role" class="bm-select">
            <option value="">All provider types</option>
            {% for r in RoleEnum %}
              {% if r.value in ['producer','studio','videographer','designer','engineer','manager','vendor'] %}
                <option value="{{ r.value }}"
                  {% if current_filters.role == r.value %}selected{% endif %}>
                  {{ r.value|capitalize }}
                </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div>
          <div class="bm-label">ZIP</div>
          <input
            type="text"
            name="zip"
            class="bm-input"
            placeholder="Any"
            value="{{ current_filters.zip }}"
          >
        </div>

        <div>
          <div class="bm-label">City</div>
          <input
            type="text"
            name="city"
            class="bm-input"
            placeholder="Any"
            value="{{ current_filters.city }}"
          >
        </div>

        <div>
          <div class="bm-label">State</div>
          <input
            type="text"
            name="state"
            class="bm-input"
            placeholder="Any"
            value="{{ current_filters.state }}"
          >
        </div>

        <div style="grid-column: 1 / -1;">
          <div class="bm-label">Search</div>
          <input
            type="text"
            name="q"
            class="bm-input"
            placeholder="Name, services, notes…"
            value="{{ current_filters.q }}"
          >
        </div>

        <div class="bm-filter-actions" style="grid-column: 1 / -1;">
          <button type="submit" class="bm-btn-primary">View results</button>
          <a href="{{ url_for('bookme_search') }}" class="bm-btn-ghost">Clear</a>
          <span style="font-size:11px; color:#9aa4c2;">
            Showing {{ profiles|length }} result{{ profiles|length != 1 and 's' or '' }}.
          </span>
        </div>
      </form>

      <!-- Provider list -->
      <div class="bm-list">
        {% if profiles %}
          {% for p in profiles %}
            <div class="bm-provider-card">
              <div>
                <div class="bm-provider-title">
                  {{ p.display_name or "Unnamed profile" }}
                  {% if p.user %}
                    <span style="font-size:12px; color:#9ca7c5;">@{{ p.user.username }}</span>
                  {% endif %}
                </div>
                <div class="bm-provider-meta-row">
                  {% if p.user %}
                    <span class="bm-chip-role">
                      {{ p.user.role.value|capitalize }}
                    </span>
                  {% endif %}
                  {% if p.city or p.state %}
                    <span class="bm-chip-location">
                      {{ p.city or '' }}{% if p.city and p.state %}, {% endif %}{{ p.state or '' }}
                    </span>
                  {% endif %}
                  {% if p.zip %}
                    <span class="bm-chip-location">ZIP {{ p.zip }}</span>
                  {% endif %}
                </div>
                {% if p.service_types %}
                  <div class="bm-provider-services">
                    {{ p.service_types }}
                  </div>
                {% endif %}
                {% if p.rate_notes %}
                  <div class="bm-provider-rate">
                    {{ p.rate_notes }}
                  </div>
                {% endif %}
              </div>

              <div class="bm-provider-actions">
                <a
                  href="{{ url_for('bookme_request', provider_id=p.user_id) }}"
                  class="bm-btn-primary"
                >
                  Request booking
                </a>
                {% if p.city or p.state %}
                  <span>
                    {{ p.city or '' }}{% if p.city and p.state %}, {% endif %}{{ p.state or '' }}
                  </span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p style="font-size:13px; color:#9aa4c2; margin-top:4px;">
            No providers match these filters yet. Try broadening your search or ask your
            engineer / studio to create a BookMe profile.
          </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Leaflet JS and BookMe map bootstrap -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (!window.L) {
        return; // Leaflet didn't load; fail silently
      }

      const mapEl = document.getElementById("bm-map");
      if (!mapEl) return;

      // Base map (centered roughly on US)
      const map = L.map("bm-map", { scrollWheelZoom: false }).setView([39, -95], 4);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      const dataUrl = "{{ url_for('bookme_data') }}?role={{ current_filters.role|urlencode }}&zip={{ current_filters.zip|urlencode }}&city={{ current_filters.city|urlencode }}&state={{ current_filters.state|urlencode }}&q={{ current_filters.q|urlencode }}";

      fetch(dataUrl)
        .then(resp => resp.json())
        .then(rows => {
          if (!Array.isArray(rows) || !rows.length) return;
          const bounds = [];
          rows.forEach(r => {
            if (r.lat == null || r.lng == null) return;
            const lat = parseFloat(r.lat);
            const lng = parseFloat(r.lng);
            if (Number.isNaN(lat) || Number.isNaN(lng)) return;

            const marker = L.marker([lat, lng]).addTo(map);
            const title = r.display_name || ("@" + (r.username || ""));
            const body = `
              <div style="font-size:13px; font-weight:600; margin-bottom:2px;">${title}</div>
              <div style="font-size:12px; margin-bottom:2px;">${r.service_types || ""}</div>
              <div style="font-size:11px; color:#64748b;">
                ${r.city || ""}${(r.city && r.state) ? ", " : ""}${r.state || ""}
              </div>
            `;
            marker.bindPopup(body);
            bounds.push([lat, lng]);
          });

          if (bounds.length) {
            map.fitBounds(bounds, { padding: [30, 30] });
          }
        })
        .catch(() => {
          // If the JSON call fails, we just leave the base map.
        });
    });
  </script>
{% endblock %}
