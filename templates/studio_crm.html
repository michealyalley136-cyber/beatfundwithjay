{% extends "base.html" %}
{% block title %}Studio CRM ¬∑ BeatFund{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  .bf-crm { max-width: 1400px; margin: 0 auto; padding: 16px; }
  .bf-hero { display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom: 20px; }
  .bf-hero-left { display:flex; gap:12px; align-items:center; min-width: 260px; }
  .bf-avatar { width: 56px; height: 56px; border-radius: 16px; object-fit: cover; border: 1px solid rgba(255,255,255,.12); }
  .bf-title { margin:0; font-size: 1.35rem; line-height: 1.2; }
  .bf-sub { margin:4px 0 0; opacity:.8; font-size: .95rem; }
  .bf-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

  .bf-grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 14px; margin-top: 14px; }
  .bf-card { border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); border-radius: 18px; padding: 16px; }
  .bf-card h3 { margin:0 0 12px; font-size: 1.1rem; font-weight: 700; }
  .bf-kpis { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
  .bf-kpi { padding: 14px; border-radius: 16px; border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); }
  .bf-kpi .label { opacity:.75; font-size: .9rem; margin-bottom: 6px; }
  .bf-kpi .value { font-size: 1.5rem; font-weight: 800; line-height: 1.2; }
  .bf-kpi .hint { opacity:.7; font-size: .85rem; margin-top: 6px; }

  .bf-btn {
    display:inline-flex; align-items:center; justify-content:center;
    padding: 12px 16px; border-radius: 14px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.08);
    color: inherit;
    text-decoration:none;
    font-weight: 600;
    min-height: 44px;
    transition: all 0.2s ease;
  }
  .bf-btn:hover { background: rgba(255,255,255,.12); transform: translateY(-1px); }
  .bf-btn.primary { background: linear-gradient(135deg, rgba(6,182,212,.4), rgba(34,197,94,.3)); border-color: rgba(6,182,212,.5); }
  .bf-btn.primary:hover { background: linear-gradient(135deg, rgba(6,182,212,.5), rgba(34,197,94,.4)); }
  .bf-btn.block { width: 100%; }
  .bf-btn-sm { padding: 8px 12px; font-size: 0.9rem; min-height: 36px; }

  .bf-list { display:flex; flex-direction:column; gap:10px; }
  .bf-row { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: rgba(0,0,0,.2); }
  .bf-row .left { min-width: 0; flex: 1; }
  .bf-row .title { font-weight: 700; font-size: 1rem; }
  .bf-row .meta { opacity:.75; font-size:.9rem; margin-top: 4px; }
  .bf-chip {
    display:inline-flex; align-items:center;
    padding: 6px 12px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size: .85rem; opacity:.9;
  }
  .bf-chip.pending { background: rgba(251,191,36,.2); border-color: rgba(251,191,36,.4); }
  .bf-chip.confirmed { background: rgba(34,197,94,.2); border-color: rgba(34,197,94,.4); }
  .bf-chip.completed { background: rgba(6,182,212,.2); border-color: rgba(6,182,212,.4); }
  .bf-chip.cancelled { background: rgba(239,68,68,.2); border-color: rgba(239,68,68,.4); }

  .bf-table { width: 100%; border-collapse: collapse; }
  .bf-table th { text-align: left; padding: 12px; border-bottom: 1px solid rgba(255,255,255,.1); font-weight: 700; font-size: 0.9rem; opacity: 0.8; }
  .bf-table td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,.05); }
  .bf-table tr:hover { background: rgba(255,255,255,.03); }

  .span-12 { grid-column: span 12; }
  .span-8 { grid-column: span 12; }
  .span-4 { grid-column: span 12; }
  .span-6 { grid-column: span 12; }

  @media (min-width: 900px){
    .span-8 { grid-column: span 8; }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
  }
</style>
{% endblock %}

{% block content %}
<div class="bf-crm">

  <div class="bf-hero">
    <div class="bf-hero-left">
      <img class="bf-avatar" src="{{ current_user.avatar_url }}" alt="avatar">
      <div>
        <h1 class="bf-title">üéôÔ∏è Studio CRM</h1>
        <p class="bf-sub">@{{ current_user.username }} ¬∑ Manage all bookings & clients</p>
      </div>
    </div>

    <div class="bf-actions">
      <a class="bf-btn" href="{{ url_for('studio_availability') }}">Availability Calendar</a>
      <a class="bf-btn" href="{{ url_for('studio_dashboard') }}">Dashboard</a>
      <a class="bf-btn" href="{{ url_for('bookme_profile') }}">Profile</a>
    </div>
  </div>

  <div class="bf-grid">

    <!-- Key Metrics -->
    <div class="bf-card span-12">
      <h3>Booking Overview</h3>
      <div class="bf-kpis">
        <div class="bf-kpi">
          <div class="label">Pending Requests</div>
          <div class="value">{{ pending_requests }}</div>
          <div class="hint">Awaiting response</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Confirmed Bookings</div>
          <div class="value">{{ confirmed_bookings }}</div>
          <div class="hint">Active bookings</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Upcoming Sessions</div>
          <div class="value">{{ upcoming_bookings|length }}</div>
          <div class="hint">Scheduled ahead</div>
        </div>
        <div class="bf-kpi">
          <div class="label">Total Bookings</div>
          <div class="value">{{ all_bookings|length }}</div>
          <div class="hint">All time</div>
        </div>
      </div>
    </div>

    <!-- Upcoming Bookings -->
    <div class="bf-card span-12">
      <h3>Upcoming Sessions</h3>
      {% if upcoming_bookings and upcoming_bookings|length > 0 %}
        <table class="bf-table">
          <thead>
            <tr>
              <th>Date & Time</th>
              <th>Client</th>
              <th>Event</th>
              <th>Duration</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for booking in upcoming_bookings[:10] %}
              <tr>
                <td>
                  {% if booking.event_datetime %}
                    {{ booking.event_datetime.strftime("%b %d, %Y") }}<br>
                    <span style="opacity: 0.7; font-size: 0.85rem;">{{ booking.event_datetime.strftime("%I:%M %p") }}</span>
                  {% else %}
                    TBD
                  {% endif %}
                </td>
                <td>
                  {% if booking.client %}
                    <a href="{{ url_for('user_profile', username=booking.client.username) }}" style="color: inherit; text-decoration: none;">
                      @{{ booking.client.username }}
                    </a>
                  {% else %}
                    Unknown
                  {% endif %}
                </td>
                <td>{{ booking.event_title }}</td>
                <td>
                  {% if booking.duration_minutes %}
                    {{ booking.duration_minutes }} min
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td>
                  <span class="bf-chip {{ booking.status }}">
                    {{ booking.status|title }}
                  </span>
                </td>
                <td>
                  <a class="bf-btn bf-btn-sm" href="{{ url_for('booking_detail', booking_id=booking.id) }}">View</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="opacity:.75; margin:12px 0;">No upcoming bookings scheduled.</p>
      {% endif %}
    </div>

    <!-- All Bookings by Status -->
    <div class="bf-card span-6">
      <h3>Pending Bookings</h3>
      {% if bookings_by_status.pending and bookings_by_status.pending|length > 0 %}
        <div class="bf-list">
          {% for booking in bookings_by_status.pending[:5] %}
            <div class="bf-row">
              <div class="left">
                <div class="title">{{ booking.event_title }}</div>
                <div class="meta">
                  {% if booking.client %}@{{ booking.client.username }}{% endif %}
                  {% if booking.event_datetime %} ¬∑ {{ booking.event_datetime.strftime("%b %d, %Y %I:%M %p") }}{% endif %}
                </div>
              </div>
              <a class="bf-btn bf-btn-sm" href="{{ url_for('booking_detail', booking_id=booking.id) }}">Manage</a>
            </div>
          {% endfor %}
        </div>
        {% if bookings_by_status.pending|length > 5 %}
          <div style="margin-top:12px;">
            <a class="bf-btn block" href="#all-bookings">View All ({{ bookings_by_status.pending|length }})</a>
          </div>
        {% endif %}
      {% else %}
        <p style="opacity:.75; margin:12px 0;">No pending bookings.</p>
      {% endif %}
    </div>

    <div class="bf-card span-6">
      <h3>Confirmed Bookings</h3>
      {% if bookings_by_status.confirmed and bookings_by_status.confirmed|length > 0 %}
        <div class="bf-list">
          {% for booking in bookings_by_status.confirmed[:5] %}
            <div class="bf-row">
              <div class="left">
                <div class="title">{{ booking.event_title }}</div>
                <div class="meta">
                  {% if booking.client %}@{{ booking.client.username }}{% endif %}
                  {% if booking.event_datetime %} ¬∑ {{ booking.event_datetime.strftime("%b %d, %Y %I:%M %p") }}{% endif %}
                </div>
              </div>
              <a class="bf-btn bf-btn-sm" href="{{ url_for('booking_detail', booking_id=booking.id) }}">View</a>
            </div>
          {% endfor %}
        </div>
        {% if bookings_by_status.confirmed|length > 5 %}
          <div style="margin-top:12px;">
            <a class="bf-btn block" href="#all-bookings">View All ({{ bookings_by_status.confirmed|length }})</a>
          </div>
        {% endif %}
      {% else %}
        <p style="opacity:.75; margin:12px 0;">No confirmed bookings.</p>
      {% endif %}
    </div>

    <!-- Booking Requests -->
    <div class="bf-card span-12" id="all-bookings">
      <h3>All Booking Requests</h3>
      {% if all_requests and all_requests|length > 0 %}
        <table class="bf-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Preferred Time</th>
              <th>Message</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for req in all_requests %}
              <tr>
                <td>{{ req.created_at.strftime("%b %d, %Y") }}</td>
                <td>
                  {% if req.client %}
                    <a href="{{ url_for('user_profile', username=req.client.username) }}" style="color: inherit; text-decoration: none;">
                      @{{ req.client.username }}
                    </a>
                  {% else %}
                    Unknown
                  {% endif %}
                </td>
                <td>{{ req.preferred_time }}</td>
                <td>{{ req.message[:50] if req.message else "‚Äî" }}{% if req.message and req.message|length > 50 %}...{% endif %}</td>
                <td>
                  <span class="bf-chip {{ req.status.value }}">
                    {{ req.status.value|title }}
                  </span>
                </td>
                <td>
                  {% if req.status == BookingStatus.pending %}
                    <form method="post" action="{{ url_for('bookme_request_status', req_id=req.id) }}" style="display:inline-flex; gap:6px;">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button class="bf-btn bf-btn-sm bf-btn-primary" name="action" value="accept">Accept</button>
                      <button class="bf-btn bf-btn-sm" name="action" value="decline">Decline</button>
                    </form>
                  {% elif req.booking %}
                    <a class="bf-btn bf-btn-sm" href="{{ url_for('booking_detail', booking_id=req.booking.id) }}">View Booking</a>
                  {% else %}
                    <span style="opacity: 0.6; font-size: 0.85rem;">‚Äî</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="opacity:.75; margin:12px 0;">No booking requests yet.</p>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}

