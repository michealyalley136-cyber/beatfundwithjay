{% extends "base.html" %}
{% block title %}Edit Profile · BeatFund{% endblock %}

{% block extra_head %}
<style>
  /* ================================
     BeatFund · Profile Edit (scoped)
     ================================ */
  .bf-profile {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
  }

  .bf-card {
    background: rgba(255,255,255,.06);
    border: 1px solid rgba(255,255,255,.12);
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    backdrop-filter: blur(10px);
  }

  .bf-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }

  .bf-title h1 {
    margin: 0;
    font-size: 1.5rem;
    line-height: 1.15;
    letter-spacing: .2px;
  }

  .bf-title p {
    margin: 6px 0 0;
    opacity: .8;
  }

  .bf-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .bf-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
    align-items: start;
  }

  @media (max-width: 920px) {
    .bf-grid { grid-template-columns: 1fr; }
    .bf-profile { padding: 14px; }
  }

  .bf-side {
    position: sticky;
    top: 12px;
  }
  @media (max-width: 920px) {
    .bf-side { position: static; }
  }

  .bf-avatar-card {
    padding: 14px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
  }

  .bf-avatar {
    width: 140px;
    height: 140px;
    border-radius: 18px;
    object-fit: cover;
    display: block;
    border: 1px solid rgba(255,255,255,.12);
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
  }

  .bf-muted {
    opacity: .78;
    font-size: .95rem;
  }

  .bf-stack { display: grid; gap: 10px; }

  .bf-form-card {
    padding: 14px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.12);
  }

  .bf-form-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 12px;
  }
  @media (max-width: 700px) {
    .bf-form-grid { grid-template-columns: 1fr; }
  }

  .bf-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    opacity: .9;
  }

  /* Inputs (scoped so we don’t break your global styles) */
  .bf-profile .form-control,
  .bf-profile input[type="text"],
  .bf-profile input[type="url"],
  .bf-profile input[type="tel"],
  .bf-profile textarea,
  .bf-profile select {
    width: 100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.25);
    color: rgba(255,255,255,.92);
    outline: none;
  }

  .bf-profile textarea { resize: vertical; min-height: 110px; }

  .bf-divider {
    height: 1px;
    background: rgba(255,255,255,.10);
    margin: 14px 0;
  }

  .bf-footer-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .bf-kicker {
    display: inline-flex;
    gap: 8px;
    align-items: center;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    font-size: .9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="bf-profile">
  <div class="bf-card">

    <div class="bf-head">
      <div class="bf-title">
        <h1>Edit Profile</h1>
        <p class="bf-muted">Update your public info, contact details, and avatar.</p>
      </div>

      <div class="bf-actions">
        <a class="btn btn-secondary" href="{{ url_for('route_to_dashboard') }}">Back to dashboard</a>
      </div>
    </div>

    {# Optional KYC badge (safe) #}
    <div class="bf-kicker" style="margin-bottom:14px;">
      <strong>KYC:</strong>
      <span class="bf-muted">
        {{ current_user.kyc_status.value.replace('_',' ').title() if current_user.kyc_status is defined else 'Unknown' }}
      </span>
    </div>

    <div class="bf-grid">

      <!-- LEFT: Avatar -->
      <div class="bf-side">
        <div class="bf-avatar-card bf-stack">
          <img class="bf-avatar" src="{{ current_user.avatar_url }}" alt="avatar">
          <div class="bf-muted">Recommended: square image, 600×600+</div>

          <form method="post" action="{{ url_for('update_avatar') }}" enctype="multipart/form-data" class="bf-stack">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input class="form-control" type="file" name="avatar" accept="image/*" required>
            <button class="btn btn-primary" type="submit">Upload new avatar</button>
          </form>
        </div>
      </div>

      <!-- RIGHT: Profile fields -->
      <div class="bf-form-card">
        <form method="post" action="{{ url_for('profile_edit') }}" class="bf-stack">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div class="bf-form-grid">
            <div class="bf-group">
              <label>Display name</label>
              <input class="form-control" name="display_name"
                     value="{{ (prof.display_name if prof else current_user.display_name) | default('', true) }}"
                     placeholder="e.g., Artist Name">
            </div>

            <div class="bf-group">
              <label>Phone number</label>
              <input class="form-control" name="phone"
                     value="{{ (prof.contact_phone if prof else '') | default('', true) }}"
                     placeholder="e.g., +1 (865) 555-1234">
            </div>

            <div class="bf-group">
              <label>City</label>
              <input class="form-control" name="city"
                     value="{{ (prof.city if prof else '') | default('', true) }}"
                     placeholder="e.g., Sevierville">
            </div>

            <div class="bf-group">
              <label>State</label>
              <input class="form-control" name="state"
                     value="{{ (prof.state if prof else '') | default('', true) }}"
                     placeholder="e.g., TN">
            </div>
          </div>

          <div class="bf-group">
            <label>Bio</label>
            <textarea class="form-control" name="bio" rows="6"
              placeholder="Tell promoters and collaborators what you do...">{{ (prof.bio if prof else '') | default('', true) }}</textarea>
          </div>

          <div class="bf-divider"></div>

          <div class="bf-footer-actions">
            <a class="btn btn-secondary" href="{{ url_for('route_to_dashboard') }}">Cancel</a>
            <button class="btn btn-primary" type="submit">Save changes</button>
          </div>

          <div class="bf-muted" style="margin-top:8px;">
            Tip: Keep your phone + city updated so bookings go smoother.
          </div>
        </form>
      </div>

    </div>
  </div>

  <!-- Role Management Section -->
  <div class="bf-card" style="margin-top: 20px;">
    <div class="bf-head">
      <div class="bf-title">
        <h2 style="font-size: 1.3rem; margin: 0;">Role Management</h2>
        <p class="bf-muted">Manage your account roles and switch between them</p>
      </div>
    </div>

    <div style="margin-top: 20px;">
      <h3 style="font-size: 1.1rem; margin: 0 0 12px; font-weight: 600;">Your Roles</h3>
      
      <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 24px;">
        {% for role in user_roles %}
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,.2); border-radius: 10px; border: 1px solid rgba(255,255,255,.1);">
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <strong>{{ get_role_display(role) }}</strong>
                {% if role == current_user.primary_role %}
                  <span style="padding: 2px 8px; background: rgba(6,182,212,.2); border: 1px solid rgba(6,182,212,.4); border-radius: 999px; font-size: .75rem; color: #4de3ff;">Primary</span>
                {% endif %}
                {% if role == active_role %}
                  <span style="padding: 2px 8px; background: rgba(34,197,94,.2); border: 1px solid rgba(34,197,94,.4); border-radius: 999px; font-size: .75rem; color: #22c55e;">Active</span>
                {% endif %}
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              {% if role != active_role %}
                <form method="POST" action="{{ url_for('role_switch') }}" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="role" value="{{ role.value }}">
                  <button type="submit" class="btn btn-secondary" style="padding: 6px 12px; font-size: .85rem;">Switch To</button>
                </form>
              {% endif %}
              {% if role != current_user.primary_role %}
                <form method="POST" action="{{ url_for('role_set_primary') }}" style="display: inline;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="role" value="{{ role.value }}">
                  <button type="submit" class="btn btn-secondary" style="padding: 6px 12px; font-size: .85rem;">Set Primary</button>
                </form>
                <form method="POST" action="{{ url_for('role_remove') }}" style="display: inline;" onsubmit="return confirm('Remove {{ get_role_display(role) }} role?')">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="role" value="{{ role.value }}">
                  <button type="submit" class="btn" style="padding: 6px 12px; font-size: .85rem; background: rgba(239,68,68,.2); border-color: rgba(239,68,68,.4); color: #ef4444;">Remove</button>
                </form>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="bf-divider"></div>

      <h3 style="font-size: 1.1rem; margin: 16px 0 12px; font-weight: 600;">Add New Role</h3>
      {% if available_roles|length > 0 %}
        <p class="bf-muted" style="margin-bottom: 12px; font-size: .9rem;">
          {% if current_user.primary_role == RoleEnum.producer %}
            As a Producer, you can add the Studio role to access studio features and dashboards.
          {% elif current_user.primary_role == RoleEnum.studio %}
            As a Studio, you can add the Producer role to access producer features and dashboards.
          {% else %}
            You can pair Producer and Studio roles together.
          {% endif %}
        </p>
        
        <form method="POST" action="{{ url_for('role_add') }}" style="display: flex; gap: 10px; align-items: end;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: 6px; opacity: .9;">Select Role</label>
            <select name="role" class="form-control" required style="width: 100%;">
              <option value="">Choose a role to add...</option>
              {% for role in available_roles %}
                <option value="{{ role.value }}">{{ get_role_display(role) }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Add Role</button>
        </form>
      {% else %}
        <p class="bf-muted" style="margin-bottom: 12px; font-size: .9rem;">
          {% if current_user.has_role(RoleEnum.producer) and current_user.has_role(RoleEnum.studio) %}
            You already have both Producer and Studio roles. No additional roles can be added.
          {% else %}
            Only Producer and Studio roles can be paired together. You don't have access to add other roles.
          {% endif %}
        </p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
