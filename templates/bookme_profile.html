{% extends "base.html" %}

{% block title %}BookMe Profile · BeatFund{% endblock %}

{% block content %}
<style>
  .bf-page {
    max-width: 1100px;
    margin: 0 auto;
    padding: 32px 16px 64px;
    color: #f9fbff;
  }
  .bf-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.6fr);
    gap: 24px;
  }
  @media (max-width: 900px) {
    .bf-grid {
      grid-template-columns: 1fr;
    }
  }
  .bf-card {
    background: radial-gradient(circle at top left, #182a44, #050712);
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.08);
    padding: 18px 20px 20px;
    box-shadow: 0 16px 40px rgba(0,0,0,0.45);
  }
  .bf-avatar-large {
    width: 96px;
    height: 96px;
    border-radius: 999px;
    overflow: hidden;
    border: 2px solid rgba(255,255,255,0.28);
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #3b82f6, #22c55e);
    font-size: 2.2rem;
    font-weight: 700;
  }
  .bf-avatar-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .bf-label {
    display: block;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    opacity: 0.75;
    margin-bottom: 4px;
  }
  .bf-input, .bf-textarea, .bf-select {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(148,163,184,0.5);
    background: rgba(15,23,42,0.9);
    color: #e5edff;
    padding: 8px 10px;
    font-size: 0.9rem;
  }
  .bf-textarea {
    min-height: 80px;
    resize: vertical;
  }
  .bf-input:focus, .bf-textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
  }
  .bf-btn-primary {
    border-radius: 999px;
    border: none;
    padding: 9px 18px;
    background: linear-gradient(135deg, #2563eb, #22c55e);
    color: #020617;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
  }
  .bf-btn-primary:hover {
    filter: brightness(1.05);
  }
  .bf-field-row {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
  }
  @media (max-width: 720px) {
    .bf-field-row {
      grid-template-columns: 1fr;
    }
  }
  .bf-small {
    font-size: 0.76rem;
    opacity: 0.75;
  }
  .bf-pill {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 999px;
    background: rgba(59,130,246,0.16);
    border: 1px solid rgba(59,130,246,0.4);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  /* NEW: secondary button style to match theme */
  .bf-btn-secondary {
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.45);
    padding: 9px 14px;
    background: rgba(15,23,42,0.75);
    color: #e5edff;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
  }
  .bf-btn-secondary:hover {
    border-color: rgba(59,130,246,0.65);
  }
  .bf-inline-status {
    margin-top: 6px;
    font-size: 0.78rem;
    opacity: 0.85;
  }
  .bf-inline-status.ok {
    color: #86efac; /* green-ish */
  }
  .bf-inline-status.err {
    color: #fca5a5; /* red-ish */
  }
</style>

<div class="bf-page">
  <h1>BookMe Provider Profile</h1>
  <p class="bf-small" style="margin-bottom: 18px;">
    This is what clients see when they search for providers in the BeatFund BookMe directory.
  </p>

  <div class="bf-grid">
    <!-- LEFT: Avatar + status -->
    <section class="bf-card">
      <h2 style="font-size:1.05rem; margin-bottom:10px;">Profile Picture &amp; Status</h2>

      <div style="display:flex; align-items:center; gap:16px; margin-bottom:16px;">
        <div class="bf-avatar-large">
          {% if current_user.avatar_path %}
            <img src="{{ url_for('media_file', filename=current_user.avatar_path) }}" alt="Avatar">
          {% else %}
            {{ current_user.username[0]|upper }}
          {% endif %}
        </div>
        <div>
          <div style="font-weight:600; font-size:1rem;">
            @{{ current_user.username }}
          </div>
          <div style="margin-top:4px;">
            <span class="bf-pill">{{ current_user.role.replace('_',' ').title() }}</span>
          </div>
          <p class="bf-small" style="margin-top:8px;">
            This avatar is shared across your dashboards and BookMe listing.
          </p>
        </div>
      </div>

      <!-- Update avatar form -->
      <form method="post" action="{{ url_for('update_avatar') }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <label class="bf-label" for="avatar">Update profile picture</label>
        <input class="bf-input" type="file" name="avatar" id="avatar" accept="image/png,image/jpeg">
        <p class="bf-small" style="margin-top:4px;">
          Recommended: square image, at least 400×400px.
        </p>
        <button type="submit" class="bf-btn-primary" style="margin-top:10px;">
          Save picture
        </button>
      </form>

      <hr style="border-color:rgba(148,163,184,0.3); margin:18px 0;">

      <p class="bf-small" style="margin-bottom:6px;">
        Once your profile is saved and visible, you’ll appear in the BookMe search for your role.
      </p>
      <p class="bf-small">
        To showcase your work, add up to 8 items in your portfolio:
        <a href="{{ url_for('bookme_portfolio') }}" style="color:#93c5fd; text-decoration:underline;">
          Manage portfolio
        </a>
      </p>
    </section>

    <!-- RIGHT: BookMe profile form -->
    <section class="bf-card">
      <h2 style="font-size:1.05rem; margin-bottom:10px;">Public BookMe Details</h2>

      <form method="post" action="{{ url_for('bookme_profile') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div style="margin-bottom:12px;">
          <label class="bf-label" for="display_name">Display Name</label>
          <input
            class="bf-input"
            id="display_name"
            name="display_name"
            type="text"
            required
            value="{{ (prof.display_name if prof else current_user.username) }}"
          >
          <p class="bf-small">
            This is the name that appears in the BookMe search (e.g. “DJ Flex”, “Skyline Choreography”).
          </p>
        </div>

        <div style="margin-bottom:12px;">
          <label class="bf-label" for="service_types">Services / Tags</label>
          <input
            class="bf-input"
            id="service_types"
            name="service_types"
            type="text"
            placeholder="DJ · Afrobeats · Wedding sets"
            value="{{ prof.service_types if prof else '' }}"
          >
          <p class="bf-small">
            Short list of styles and services you offer (comma- or dot-separated).
          </p>
        </div>

        <div style="margin-bottom:12px;">
          <label class="bf-label" for="contact_phone">Contact Phone</label>
          <input
            class="bf-input"
            id="contact_phone"
            name="contact_phone"
            type="text"
            placeholder="+1 555 123 4567"
            value="{{ prof.contact_phone if prof else '' }}"
          >
          <p class="bf-small">
            This number is shown to clients when they view your BookMe profile.
          </p>
        </div>

        <div style="margin-bottom:12px;">
          <label class="bf-label" for="bio">Bio / About</label>
          <textarea
            class="bf-textarea"
            id="bio"
            name="bio"
            placeholder="Tell clients what you do, your experience, and what makes you different."
          >{{ prof.bio if prof else '' }}</textarea>
        </div>

        <div style="margin-bottom:12px;">
          <label class="bf-label" for="rate_notes">Rate Notes</label>
          <textarea
            class="bf-textarea"
            id="rate_notes"
            name="rate_notes"
            placeholder="Example: Club sets from $300; weddings from $800; travel fees may apply."
          >{{ prof.rate_notes if prof else '' }}</textarea>
        </div>

        <div class="bf-field-row" style="margin-bottom:12px;">
          <div>
            <label class="bf-label" for="city">City</label>
            <input
              class="bf-input"
              id="city"
              name="city"
              type="text"
              value="{{ prof.city if prof else '' }}"
            >
          </div>
          <div>
            <label class="bf-label" for="state">State / Region</label>
            <input
              class="bf-input"
              id="state"
              name="state"
              type="text"
              value="{{ prof.state if prof else '' }}"
            >
          </div>
        </div>

        <div class="bf-field-row" style="margin-bottom:12px;">
          <div>
            <label class="bf-label" for="zip">ZIP / Postal Code</label>
            <input
              class="bf-input"
              id="zip"
              name="zip"
              type="text"
              value="{{ prof.zip if prof else '' }}"
            >
          </div>
          <div>
            <label class="bf-label" for="address">Address (optional)</label>
            <input
              class="bf-input"
              id="address"
              name="address"
              type="text"
              value="{{ prof.address if prof else '' }}"
            >
          </div>
        </div>

        <div class="bf-field-row" style="margin-bottom:8px;">
          <div>
            <label class="bf-label" for="lat">Latitude (optional)</label>
            <input
              class="bf-input"
              id="lat"
              name="lat"
              type="text"
              value="{{ prof.lat if prof and prof.lat is not none else '' }}"
              inputmode="decimal"
              placeholder="e.g. 35.868145"
            >
          </div>
          <div>
            <label class="bf-label" for="lng">Longitude (optional)</label>
            <input
              class="bf-input"
              id="lng"
              name="lng"
              type="text"
              value="{{ prof.lng if prof and prof.lng is not none else '' }}"
              inputmode="decimal"
              placeholder="e.g. -83.561523"
            >
          </div>
        </div>

        <!-- NEW: Use my location button + status -->
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
          <button type="button" class="bf-btn-secondary" id="useMyLocation">
            Use my current location
          </button>
          <div id="geoStatus" class="bf-inline-status" aria-live="polite"></div>
        </div>

        <p class="bf-small" style="margin-top:-6px; margin-bottom:12px;">
          Tip: adding latitude &amp; longitude makes your pin show on the BookMe map.
          After clicking “Use my current location”, click “Save BookMe profile”.
        </p>

        <button type="submit" class="bf-btn-primary">
          Save BookMe profile
        </button>
      </form>
    </section>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById("useMyLocation");
    const statusEl = document.getElementById("geoStatus");
    const latInput = document.getElementById("lat");
    const lngInput = document.getElementById("lng");

    function setStatus(msg, kind) {
      if (!statusEl) return;
      statusEl.textContent = msg || "";
      statusEl.classList.remove("ok", "err");
      if (kind) statusEl.classList.add(kind);
    }

    if (!btn) return;

    btn.addEventListener("click", function () {
      setStatus("", null);

      if (!navigator.geolocation) {
        setStatus("Geolocation is not supported in this browser.", "err");
        return;
      }

      btn.disabled = true;
      btn.style.opacity = "0.7";
      setStatus("Getting your location…", null);

      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          if (latInput) latInput.value = Number(lat).toFixed(6);
          if (lngInput) lngInput.value = Number(lng).toFixed(6);

          setStatus("Location added. Click “Save BookMe profile” to store it.", "ok");

          btn.disabled = false;
          btn.style.opacity = "1";
        },
        function (err) {
          let msg = "Could not get location.";
          if (err && err.message) msg += " " + err.message;
          setStatus(msg, "err");

          btn.disabled = false;
          btn.style.opacity = "1";
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });
  })();
</script>
{% endblock %}
